@using NetTopologySuite.IO
@using Wayfarer.Util
@model Wayfarer.Models.Region
@{
    double? lat = Model.Center?.Y; // Y = latitude
    double? lon = Model.Center?.X; // X = longitude

    /* helpers for Wayfarer marker PNG */
    string SafeIcon(string? icon) => string.IsNullOrWhiteSpace(icon) ? "marker" : icon.Trim();
    string SafeBg(string? color) => string.IsNullOrWhiteSpace(color) ? "bg-blue" : color.Trim();
    string Png(string ic, string bg) => $"/icons/wayfarer-map-icons/dist/png/marker/{bg}/{ic}.png";

    /* visit counts per place - privacy: only owner OR ShareProgressEnabled sees visit status */
    var placeVisitCounts = ViewBag.PlaceVisitCounts as Dictionary<Guid, int> ?? new Dictionary<Guid, int>();
    var isOwner = ViewBag.IsOwner == true;
    var shareProgressEnabled = ViewBag.ShareProgressEnabled == true;
    var showVisitStatus = isOwner || shareProgressEnabled;
}

<div class="accordion-item"
     id="region-@Model.Id"
     data-region-id="@Model.Id"
     data-region-name="@Model.Name"
     @(lat is not null ? $"data-center-lat=\"{lat}\"" : "")
     @(lon is not null ? $"data-center-lon=\"{lon}\"" : "")>

    <!-- header: button (expand/collapse) + separate checkbox -->
    <h2 class="accordion-header d-flex align-items-center text-bg-light ">

        <!-- collapsible button (100 % width) -->
        <button class="accordion-button flex-grow-1 px-2"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#reg-body-@Model.Id">
            <span class="fw-semibold">
                @Model.Name
            </span>
        </button>

        <!-- visibility toggle – OUTSIDE the button -->
        <input type="checkbox"
               class="form-check-input ms-2 region-toggle fs-6 mx-1"
               checked
               title="Show/Hide this region on map"/>
    </h2>

    <div id="reg-body-@Model.Id" class="accordion-collapse show">
        <div class="accordion-body p-0">
            @* Region cover image - shown if present *@
            @if (!string.IsNullOrWhiteSpace(Model.CoverImageUrl))
            {
                <div class="region-cover-image px-2 py-1 border-bottom">
                    <img src="@Model.CoverImageUrl" alt="@Model.Name" class="img-fluid rounded" style="max-height: 150px; object-fit: cover; width: 100%;" />
                </div>
            }
            @* Region notes - shown if present, scrollable like trip notes *@
            @if (HtmlHelpers.HasVisibleContent(Model.Notes))
            {
                <div class="small text-muted px-2 py-1 border-bottom" style="max-height: 150px; overflow-y: auto;">
                    @Html.Raw(Model.Notes)
                </div>
            }
            <ul class="list-group list-group-flush">

                @foreach (var p in Model.Places?.OrderBy(pl => pl.DisplayOrder)
                                   ?? Enumerable.Empty<Wayfarer.Models.Place>())
                {
                    var iconName = SafeIcon(p.IconName);
                    var bgClass = SafeBg(p.MarkerColor);
                    var iconUrl = Png(iconName, bgClass);

                    var pLat = p.Location?.Y;
                    var pLon = p.Location?.X;
                    placeVisitCounts.TryGetValue(p.Id, out var vc);
                    var visitCount = showVisitStatus ? vc : 0;
                    <text>
                        <li class="list-group-item place-list-item d-flex align-items-center gap-2 py-1 px-2 pe-clickable"
                            data-place-id="@p.Id"
                            data-place-name="@p.Name"
                            data-place-address="@p.Address"
                            data-place-icon="@iconName"
                            data-place-color="@bgClass"
                            data-region-id="@Model.Id"
                            data-region-name="@Model.Name"
                            @if (visitCount > 0)
                            {
                            <text> data-place-visit-count="@visitCount" </text>
                            }
                            @if (pLat is not null)
                            {
                            <text> data-place-lat="@pLat" </text>
                            }
                            @if (pLon is not null)
                            {
                            <text> data-place-lon="@pLon" </text>
                            }
                            title="Click to view details">

                            <span class="sidebar-place-icon">
                                @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_MapIcon.cshtml",
                                    (iconName, bgClass))
                                @if (visitCount > 0)
                                {
                                    <span class="sidebar-visit-badge" title="@(visitCount == 1 ? "Visited" : $"Visited {visitCount} times")">@(visitCount == 1 ? "✓" : visitCount)</span>
                                }
                            </span>
                            <span class="flex-grow-1">@p.Name</span>

                            <div class="d-none place-notes">
                                @Html.LinkifyHtml(p.Notes)
                            </div>
                        </li>
                    </text>
                }
            </ul>

            @if (Model.Areas?.Any() == true)
            {
                <div class="mt-3">
                    <h6>Areas</h6>
                    <ul class="list-group list-group-flush">
                        @foreach (var area in Model.Areas.OrderBy(a => a.DisplayOrder))
                        {
                            <li class="list-group-item d-flex align-items-center justify-content-between area-list-item"
                                data-area-id="@area.Id"
                                data-region-id="@Model.Id"
                                data-area-geom='@(area.Geometry != null
                                                    ? new GeoJsonWriter().Write(area.Geometry)
                                                    : "null")'
                                data-area-fill="@area.FillHex"
                                data-area-name="@area.Name"
                                data-area-notes="@(area.Notes ?? "")">

                                @* Layout fix: let the area content column stretch so notes fill available width. *@
                                <div class="d-flex flex-column flex-grow-1 me-2">
                                    <!-- first row: icon + name -->
                                    <div class="d-flex align-items-center">
                                        @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_CircleIcon.cshtml",
                                            ("flag", "bg-green"))
                                        <strong class="area-name ms-2">@area.Name</strong>
                                    </div>

                                    <!-- second row: rich-text notes (scrollable) -->
                                    @if (HtmlHelpers.HasVisibleContent(area.Notes))
                                    {
                                        <div class="small text-muted" style="max-height: 100px; overflow-y: auto;">
                                            @Html.Raw(area.Notes)
                                        </div>
                                    }
                                </div>

                                <input type="checkbox"
                                       class="form-check-input area-toggle"
                                       checked
                                       data-area-id="@area.Id"
                                       title="Show/Hide this area"/>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
</div>
