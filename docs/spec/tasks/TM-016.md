---
id: TM-016
title: Localize User-Facing Location Timestamps
status: planning
labels: [ui, timezone]
deps: [TM-015]
inputs:
  - design/Trusted Managers Mechanism.md
outputs: []
timebox: "3h"
---

## Summary
Location timestamps are rendered with `Date.prototype.toISOString()`, so every “Local Datetime” label ends up in UTC. Viewers see the wrong day/hour, stats roll over incorrectly, and the experience is confusing—especially when friends follow travellers across time zones. We must display timestamps in the viewer’s current timezone **and** surface the recorded location timezone for context.

## Current Behavior
- **User Timeline (map + chronological)**  
  - `wwwroot/js/Areas/User/Timeline/index.js:234` and `wwwroot/js/Areas/User/Timeline/chronological.js:737` inject UTC strings via `toISOString()`.  
  - Timeline summaries and visit ranges use `toISOString().split('T')[0]` (`index.js:519`, `chronological.js:464` etc.), so users behind UTC lose a day.  
  - Country/region stats share the same issue (`index.js:623`, `chronological.js:480`).
- **User Location (map + all locations)**  
  - Tables and modals call `toISOString()` (`wwwroot/js/Areas/User/Location/Index.js:504`, `AllLocations.js:199`, `Index.js:312`, `AllLocations.js:323`).  
  - Search defaults use `new Date().toISOString()` (`Index.js:37`, `AllLocations.js:10`), which can prefill tomorrow’s date.
- **Groups Maps (User + Manager)**  
  - Popovers render UTC timestamps (`wwwroot/js/Areas/User/Groups/map.js:245`, `wwwroot/js/Areas/Manager/Groups/map.js:285`).  
  - Month navigation helpers parse ISO strings (`User map.js:194`, `Manager map.js:180`).
- **Public Users Timeline (site + embed)**  
  - Same UTC formatting in map modals and stats (`wwwroot/js/Areas/Public/Timeline/index.js:207`, `embed.js:211`, plus stats around `index.js:503`, `embed.js:505`).
- **Server-rendered tables**  
  - Invite tables rely on `ToLocalTime()` (`Areas/User/Views/Groups/Members.cshtml:105`, `Areas/Manager/Views/Groups/Members.cshtml:129`), tying output to the server timezone.

## Proposed Changes
1. **Shared datetime utility**  
   - Add `wwwroot/js/util/datetime.js` exporting helpers, e.g.  
     `formatDateTime({ iso, displayTimeZone, style, includeOffset })` and `formatDate({ iso, displayTimeZone })`.  
   - Default `displayTimeZone` to the viewer’s `Intl.DateTimeFormat().resolvedOptions().timeZone`, but accept overrides (e.g., recorded timezone).  
   - Use explicit options (`year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false`) so ordering is consistent regardless of UI locale. Include offset text such as `GMT+03:00`.
2. **Dual-display pattern**  
   - Primary line: viewer-local timestamp (so a friend in Greece sees Greek time).  
   - Secondary line/badge: recorded location time using `location.timezone || location.timeZoneId` when present (`Local at source: 2025-10-19 16:30 (Europe/Berlin)`).  
   - Store the raw ISO in `data-utc` for tooltips or future enhancements.
3. **Timeline modules (User + Public)**  
   - Replace every `toISOString()` call with the helper.  
   - Update summaries, filters, and stats to rely on viewer-local formatting; append the recorded timezone tag where it provides context.  
   - Ensure chronological view navigation and SSE updates reuse the helper.
4. **Location management views**  
   - Format table cells and modal content using the dual-display pattern.  
   - Default search date inputs with `new Date().toLocaleDateString('sv-SE')` (viewer-local ISO-like) rather than UTC.  
   - When exporting tooltips or copying data, consider including both representations.
5. **Groups map views (User + Manager)**  
   - Apply the helper inside popovers/tooltips.  
   - Replace month/day navigation logic that relies on `toISOString()` with pure `Date` arithmetic in viewer timezone.
6. **Public timeline (site + embed)**  
   - Mirror the dual-display approach, including stats and SSE refresh logic.
7. **Server Razor tables**  
   - Emit ISO strings in `data-created-at` attributes and format them client-side with the helper. This keeps the server neutral and honours each viewer’s timezone.
8. **Documentation + guardrails**  
   - Record the formatting pattern/style guide in the repo wiki/specs.  
   - Add a manual regression checklist covering midnight-edge cases and dual-time display.
9. **Branching instructions**  
   - Develop the feature on a dedicated branch (e.g., `feature/tm-016-local-time-display`).  
   - After implementation and validation, the project owner will handle merging that branch into `master` following final tests/review.

## Testing Plan
- Seed locations with known offsets (e.g., Athens, New York, Tokyo). For each surface confirm:  
  - Primary timestamp matches the viewer’s current timezone (simulate Greece vs. US viewers).  
  - Secondary label reflects the recorded `timeZoneId`.  
  - Stats/date filters roll up to the correct local day.
- Toggle OS timezone and language (e.g., viewer in Greece with browser language `en-US`) to verify ordering stays `YYYY-MM-DD HH:mm`.
- Validate search defaults around UTC midnight—for a viewer at UTC-5 ensure the “To Date” field stays on the expected day.
- Check invite tables after client-side formatting.  
- Run `dotnet build` and manual SSE smoke tests to ensure live updates continue to render correctly.

## Risks & Mitigations
- **Missing `timeZoneId`**: Some records may lack source timezone; fall back to viewer time only and flag the absence (e.g., “Source timezone unknown”).  
- **Legacy browser support**: Provide a guarded fallback if `Intl` APIs are unavailable (basic manual formatting).  
- **Data drift**: If backend ever changes timestamp semantics, keep the helper isolated so future adjustments are centralized.
