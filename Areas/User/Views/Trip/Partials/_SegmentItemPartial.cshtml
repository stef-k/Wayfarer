@using System.Text.Json
@model Segment

@{
    var fromName = Model.FromPlace?.Name ?? "Start";
    var toName = Model.ToPlace?.Name ?? "End";
    var segmentId = Model.Id;
    var mode = Model.Mode ?? "Segment";
    var duration = Model.EstimatedDuration?.ToString(@"hh\:mm") ?? "â€”";
    var distance = Model.EstimatedDistanceKm?.ToString("0.##") ?? "â€”";
    var hasNotes = !string.IsNullOrWhiteSpace(Model.Notes);
    var routeJson = Model.RouteGeometry != null
        ? JsonSerializer.Serialize(
            Model.RouteGeometry.Coordinates.Select(c => new[] { c.Y, c.X })
        )
        : "[]";

    var emojiMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["walk"] = "ğŸš¶",
        ["bicycle"] = "ğŸš´",
        ["bike"] = "ğŸï¸",
        ["car"] = "ğŸš—",
        ["bus"] = "ğŸšŒ",
        ["train"] = "ğŸš†",
        ["ferry"] = "â›´ï¸",
        ["boat"] = "ğŸš¤",
        ["flight"] = "âœˆï¸",
        ["helicopter"] = "ğŸš",
        ["drive"] = "ğŸš—",
        ["taxi"] = "ğŸš•",
        ["tram"] = "ğŸšŠ"
    };

    var modeKey = (Model.Mode ?? "").ToLowerInvariant();
    var emojiIcon = emojiMap.ContainsKey(modeKey) ? emojiMap[modeKey] : "â“";
}

<!-- âœ… Multi-line segment list item -->
<li class="segment-list-item list-group-item py-2"
    id="segment-item-@Model.Id"
    data-segment-id="@segmentId"
    data-segment-name="@($"{Model.Mode}: {fromName} â†’ {toName}")"
    data-segment-mode="@Model.Mode"
    data-segment-from="@fromName"
    data-segment-to="@toName"
    data-segment-distance="@distance"
    data-segment-duration="@Model.EstimatedDuration?.ToString("c")"
    data-from-lat="@(Model.FromPlace?.Location?.Y ?? 0)"
    data-from-lon="@(Model.FromPlace?.Location?.X ?? 0)"
    data-to-lat="@(Model.ToPlace?.Location?.Y ?? 0)"
    data-to-lon="@(Model.ToPlace?.Location?.X ?? 0)">

    <!-- Line 1 & 2: Mode, icon, duration/distance, controls -->
    <div class="d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex gap-2 align-items-start">
            <i class="bi bi-grip-vertical drag-handle mt-1" title="Drag to reorder"></i>
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center gap-2">
                    <span class="emoji-icon fs-5" aria-label="@Model.Mode icon"
                          title="@Model.Mode icon">@emojiIcon</span>
                    <strong>@Model.Mode</strong>
                </div>
                <div class="ms-1">( @duration / @distance km )</div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            @if (hasNotes)
            {
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#segmentNotesModal-@segmentId"
                        title="Click to view notes">
                    <i class="bi bi-info-circle"></i>
                </button>
            }

            <input type="checkbox"
                   class="form-check-input btn-segment-toggle-visibility"
                   id="segment-visibility-@segmentId"
                   data-segment-id="@segmentId"
                   checked
                   title="Show/Hide this segment on map"/>

            <button class="btn btn-outline-primary btn-sm btn-edit-segment"
                    data-segment-id="@segmentId"
                    title="Edit segment">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm btn-delete-segment"
                    data-segment-id="@segmentId"
                    title="Delete segment">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>

    <!-- Line 3 & 4: From â†’ To label, with optional notes icon -->
    <div class="mt-1 ms-4 ">
        <input type="hidden" name="RouteJson" value="@routeJson"/>

        <div class="mb-1"><strong>From:</strong> @fromName (@Model?.FromPlace?.Region?.Name)</div>
        <div><strong>To:</strong> @toName (@Model?.ToPlace?.Region?.Name)</div>
    </div>
</li>

@if (hasNotes)
{
    <div class="modal fade" id="segmentNotesModal-@segmentId" tabindex="-1"
         aria-labelledby="segmentNotesLabel-@segmentId" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="segmentNotesLabel-@segmentId">
                        Notes for <span class="fw-semibold">@mode from @fromName to @toName</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @if (Model != null)
                    {
                        @Html.Raw(Model.Notes ?? string.Empty)
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary"
                            data-bs-dismiss="modal">Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}
