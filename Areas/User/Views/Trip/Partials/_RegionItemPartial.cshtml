@using System.Globalization
@model Wayfarer.Models.Region
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="accordion-item" id="region-item-@Model.Id" data-region-id="@Model.Id" 
     data-region-name="@Model.Name" data-center-lat="@Model.Center?.Y.ToString(CultureInfo.InvariantCulture)" 
     data-center-lon="@Model.Center?.X.ToString(CultureInfo.InvariantCulture)">
    <h2 class="accordion-header region-header" id="heading-@Model.Id">
        <div class="d-flex justify-content-between align-items-center w-100">
            <i class="bi bi-grip-vertical drag-handle me-1"></i>
            <!-- Toggler (collapse control) -->
            <button class="accordion-button collapsed flex-grow-1 text-start"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-@Model.Id"
                    aria-expanded="false"
                    aria-controls="collapse-@Model.Id">
                <span class="d-flex align-items-center gap-2">
                    <img src="/icons/wayfarer-map-icons/dist/png/marker/bg-red/map.png"
                         alt="Region marker"
                         width="20"
                         height="30"
                         class="map-icon me-1" />

                    <strong>@Model.Name</strong>
                </span>
            </button>
            <!-- Select region action -->
            <button type="button"
                    class="btn btn-outline-primary btn-sm me-2 region-select-area"
                    data-region-id="@Model.Id"
                    data-region-name="@Model.Name"
                    title="Focus map on this region">
                <i class="bi bi-geo-alt-fill"></i>
            </button>
        </div>
    </h2>

    <div id="collapse-@Model.Id" class="accordion-collapse collapse show">
        <div class="accordion-body">
            @* region fields *@
            <div class="row text-muted mb-2">
                @if (Model.Center != null)
                {
                    <div class="col-6"><strong>Lat:</strong> <code>@(Model.Center.Y.ToString("F5", CultureInfo.InvariantCulture))</code> </div>
                    <div class="col-6"><strong>Lon:</strong> <code>@(Model.Center.X.ToString("F5", CultureInfo.InvariantCulture))</code></div>
                }
            </div>
            <!-- Action buttons -->
            <div class="mb-3">
                <button type="button"
                        data-region-id="@Model.Id"
                        class="btn btn-sm btn-outline-primary btn-edit-region me-1" title="Edit Region">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button type="button"
                        data-region-id="@Model.Id"
                        class="btn btn-sm btn-outline-danger btn-delete-region" title="Delete Region">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>

            <!-- Places -->
            <div class="ps-1">
                <h6>Places</h6>

                @if (Model.Places != null && Model.Places.Any())
                {
                    <ul class="list-group list-group-flush small" data-region-places id="places-@Model.Id">
                        @foreach (var place in Model.Places.OrderBy(p => p.DisplayOrder))
                        {
                            <li class="place-list-item list-group-item d-flex  align-items-center"
                                data-place-id="@place.Id"
                                data-region-id="@Model.Id"
                                data-place-lat="@place.Location?.Y"
                                data-place-lon="@place.Location?.X"
                                data-place-icon="@place.IconName"
                                data-place-color="@place.MarkerColor">
                                <i class="bi bi-grip-vertical drag-handle me-1"></i>
                                <span class="place-name">
                                    @* inject SVG and add colour class *@
                                    @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_MapIcon.cshtml", (place.IconName, place.MarkerColor))
                                    @place.Name
                                </span>
                                @if (place.Location != null)
                                {
                                    <span class="badge bg-light text-secondary fw-normal small">
                                        @(place.Location.Y.ToString("F5", CultureInfo.InvariantCulture)), @(place.Location.X.ToString("F5", CultureInfo.InvariantCulture))
                                    </span>
                                }
                                <div class="btn-group btn-group-sm ms-auto">
                                    <button type="button"
                                            class="btn btn-outline-primary btn-edit-place"
                                            data-place-id="@place.Id"
                                            data-region-id="@Model.Id"
                                            title="Edit place">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-danger btn-delete-place"
                                            data-place-id="@place.Id"
                                            data-region-id="@Model.Id"
                                            title="Delete place">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </li>
                        }

                    </ul>
                }
                else
                {
                    <div class="alert alert-info p-2 small mb-2" role="alert">
                        <i class="bi bi-info-circle me-1"></i> No places added to this region yet.
                    </div>
                }
            </div>

            <!-- Add Place Button -->
            <div class="ps-1 mt-2 mb-3">
                <button type="button"
                        class="btn btn-sm btn-success btn-add-place"
                        data-region-id="@Model.Id">
                    <i class="bi bi-plus-circle"></i> Add Place
                </button>
            </div>
        </div>
    </div>
</div>
