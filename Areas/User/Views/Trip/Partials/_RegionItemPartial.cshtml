@using System.Globalization
@model Wayfarer.Models.Region
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@functions {
    string? GetFirstImageSrc(string? html)
    {
        if (string.IsNullOrWhiteSpace(html)) return null;

        var match = System.Text.RegularExpressions.Regex.Match(html, "<img[^>]+src=\"([^\"]+)\"");
        return match.Success ? match.Groups[1].Value : null;
    }
}

<div class="accordion-item" id="region-item-@Model.Id" data-region-id="@Model.Id" data-region-name="@Model.Name"
    data-center-lat="@Model.Center?.Y.ToString(CultureInfo.InvariantCulture)"
    data-center-lon="@Model.Center?.X.ToString(CultureInfo.InvariantCulture)"
    data-region-is-shadow='@(Model.Name == "Unassigned Places" ? "true" : "false")'>
    <h2 class="accordion-header region-header" id="heading-@Model.Id">
        <div class="d-flex justify-content-between align-items-center w-100">
            <i class="bi bi-grip-vertical drag-handle me-1"></i>
            <!-- Toggler (collapse control) -->
            <button class="accordion-button collapsed flex-grow-1 text-start" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-@Model.Id" aria-expanded="false" aria-controls="collapse-@Model.Id">
                <span class="d-flex align-items-center gap-2">
                    <img src="/icons/wayfarer-map-icons/dist/png/marker/bg-red/map.png" alt="Region marker" width="20"
                        height="30" class="map-icon me-1" />

                    <strong>@Model.Name</strong>
                </span>
            </button>
            <!-- Select region action -->
            <button type="button" class="btn btn-outline-primary btn-sm mx-1 region-select-area"
                data-region-id="@Model.Id" data-region-name="@Model.Name" title="Focus map on this region">
                <i class="bi bi-geo-alt-fill"></i>
            </button>
        </div>
    </h2>

    <div id="collapse-@Model.Id" class="accordion-collapse collapse show">
        <div class="accordion-body">
            @* region fields *@
            <div class="row text-muted mb-2">
                @if (Model.Center != null)
                {
                    <div class="col-6"><strong>Lat:</strong>
                        <code>@(Model.Center.Y.ToString("F5", CultureInfo.InvariantCulture))</code>
                    </div>
                    <div class="col-6"><strong>Lon:</strong>
                        <code>@(Model.Center.X.ToString("F5", CultureInfo.InvariantCulture))</code>
                    </div>
                }
            </div>
            @if (!string.IsNullOrWhiteSpace(Model.CoverImageUrl))
            {
                <div class="row">
                    <div class="col-12 mt-2 text-center">
                        <a href="@Model.CoverImageUrl" target="_blank" rel="noopener noreferrer"
                            title="Open full image in new tab">
                            <img src="@Model.CoverImageUrl" class="img-fluid rounded shadow-sm" alt="Region Cover Preview"
                                style="max-height: 150px;" />
                        </a>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Model.Notes))
            {
                <div class="row">
                    <div class="col-12 mt-2">
                        @Html.LinkifyHtml(Model.Notes)
                    </div>
                </div>
            }

            <!-- Action buttons -->
            @if (Model.Name != "Unassigned Places")
            {
                <div class="row">
                    <div class="col-12">
                        <div class="my-3">
                            <button type="button" data-region-id="@Model.Id"
                                    class="btn btn-sm btn-outline-primary btn-edit-region me-1" title="Edit Region">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button type="button" data-region-id="@Model.Id"
                                    class="btn btn-sm btn-outline-danger btn-delete-region" title="Delete Region">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
            <!-- Places -->
            <div class="ps-1">
                <h6>Places</h6>

                @if (Model.Places != null && Model.Places.Any())
                {
                    <ul class="list-group list-group-flush small" data-region-places id="places-@Model.Id" data-region-id="@Model.Id">
                        @foreach (var place in Model.Places.OrderBy(p => p.DisplayOrder))
                        {
                            <li class="place-list-item list-group-item d-flex  align-items-center" data-place-id="@place.Id"
                                data-region-id="@Model.Id" data-place-lat="@place.Location?.Y"
                                data-place-lon="@place.Location?.X" data-place-icon="@place.IconName"
                                data-place-color="@place.MarkerColor" data-place-name="@place.Name?.Trim()"
                                data-place-address="@place.Address"
                                data-region-name="@Model.Name">
                                <i class="bi bi-grip-vertical drag-handle me-1"></i>
                                @* Hidden div for notes - used by popup builder *@
                                <div class="d-none place-notes">@Html.LinkifyHtml(place.Notes)</div>

                                @if (place.Location != null)
                                {
                                    <span title="This place has coordinates set, click to see which marker is on map">
                                        @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_MapIcon.cshtml",
                                        (place.IconName, place.MarkerColor))
                                    </span>
                                }

                                @if (!string.IsNullOrWhiteSpace(place.Notes) || !string.IsNullOrWhiteSpace(place.Address))
                                {
                                    <button type="button" class="btn btn-sm btn-link px-1 py-0" data-bs-toggle="modal"
                                        data-bs-target="#placeNotesModal-@place.Id" title="Click to view details">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                }

                                <span class="text-truncate d-inline-block" style="max-width: 80%;" title="@place.Name">
                                    @place.Name
                                </span>

                                <div class="btn-group btn-group-sm ms-auto">
                                    <button type="button" class="btn btn-outline-primary btn-edit-place"
                                        data-place-id="@place.Id" data-region-id="@Model.Id" title="Edit place">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-delete-place"
                                        data-place-id="@place.Id" data-region-id="@Model.Id" title="Delete place">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </li>
                            @if (!string.IsNullOrWhiteSpace(place.Notes) || !string.IsNullOrWhiteSpace(place.Address))
                            {
                                <div class="modal fade" id="placeNotesModal-@place.Id" tabindex="-1"
                                    aria-labelledby="placeNotesLabel-@place.Id" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-scrollable modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="placeNotesLabel-@place.Id">
                                                    Details for <span class="fw-semibold">@place.Name</span>
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">

                                                @if (!string.IsNullOrWhiteSpace(place.Address))
                                                {
                                                    <h6>Address:</h6>
                                                    <Address class="user-select-all">@Html.Raw(place.Address)</Address>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(place.Notes))
                                                {
                                                    <h6>Notes:</h6>
                                                    @Html.LinkifyHtml(place.Notes)
                                                }
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-sm btn-secondary"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                        }

                    </ul>
                }
                else
                {
                    <div class="alert alert-info p-2 small mb-2" role="alert">
                        <i class="bi bi-info-circle me-1"></i> No places added to this region yet.
                    </div>
                }
            </div>

            <!-- Areas list -->
            @if (Model.Areas?.Any() == true)
            {
                <div data-region-areas class="mt-3">
                    <h6>Areas</h6>
                    <ul class="list-group list-group-flush">
                        @foreach (var area in Model.Areas.OrderBy(a => a.DisplayOrder))
                        {
                            @await Html.PartialAsync(
                                "~/Areas/User/Views/Trip/Partials/_AreaItemPartial.cshtml",
                                area
                            )
                        }
                    </ul>
                </div>
            }
            else
            {
                <div data-region-areas class="mt-3">
                    <div class="alert alert-info p-2 small mb-2">
                        <i class="bi bi-info-circle me-1"></i> No areas added to this region yet.
                    </div>
                </div>
            }
            
            <!-- Add Place Button -->
            <div class="ps-1 mt-2 mb-3">
                <button type="button" 
                        class="btn btn-sm btn-success btn-add-place" 
                        data-region-id="@Model.Id" 
                        title="Add a new Place in this Region">
                    <i class="bi bi-plus-circle"></i> Add Place
                </button>
                
                <button type="button"
                        class="btn btn-sm btn-outline-secondary btn-add-area"
                        title="Add an Area in this Region"
                        data-region-id="@Model.Id">
                    <i class="bi bi-draw"></i> Add Area
                </button>
            </div>
        </div>
    </div>
</div>
