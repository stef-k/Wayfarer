@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model Wayfarer.Models.Trip

@{
  ViewData["LoadLeaflet"] = true;
  ViewData["LoadQuill"] = true;
  Layout = "~/Views/Shared/_Layout.cshtml";
  var regions = Model.Regions ?? new List<Region>();
  ViewData["BodyClass"] = "container-fluid";
}

<div class="row">
  <div class="col-3">

    <div id="sidebar" class="show collapse-horizontal d-flex flex-column">
      <!-- Sidebar Header -->
      <div id="sidebarHeader" class="p-3 border-bottom d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Trip Settings</h5>

        <div class="d-flex align-items-center gap-2">
          <button type="button"
                  id="btn-trip-recenter"
                  class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-1"
                  title="Recenter map to saved trip view">
            <i class="bi bi-geo-alt-fill"></i>
            <span class="d-none d-md-inline">Map</span>
          </button>

          <button class="btn btn-link p-0" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#tripSettingsCollapse"
                  aria-expanded="true"
                  aria-controls="tripSettingsCollapse">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>


      <!-- Sidebar Content -->
      <div id="sidebarContent" class="flex-grow-1 overflow-y-auto p-3">
        <div class="collapse show" id="tripSettingsCollapse">
          <form id="trip-form" class="row g-3 mb-4">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id"/>
            <input type="hidden" asp-for="Id" id="trip-id" />
            <input type="hidden" asp-for="CenterLat" data-default="@Model.CenterLat?.ToString("F6")" />
            <input type="hidden" asp-for="CenterLon" data-default="@Model.CenterLon?.ToString("F6")" />
            <input type="hidden" asp-for="Zoom"      data-default="@Model.Zoom" />
            <div class="col-md-12">
              <span class="text-muted small">Last updated at @Model.UpdatedAt.ToLongDateString()</span>
            </div>
            <div class="col-md-12">
              <label asp-for="Name" class="form-label"></label>
              <input asp-for="Name" class="form-control"/>
              <div class="invalid-feedback" asp-validation-for="Name"></div>
            </div>
            <div class="col-md-6 align-self-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="isPublicSwitch" asp-for="IsPublic">
                <label class="form-check-label" for="isPublicSwitch">Make Trip Public</label>
                <div class="invalid-feedback" asp-validation-for="IsPublic"></div>
              </div>
            </div>
            <div class="col-md-12">
              <label for="notes">Notes</label>
              <div id="notes" data-notes-content="@Model.Notes"></div>
              <input type="hidden" asp-for="Notes" id="Notes" />
              <small class="text-muted">
                You cannot paste images in here. Use the image button from the toolbar to insert an image from a URL.
              </small>
              <div class="invalid-feedback" asp-validation-for="Notes"></div>
            </div>
            <div class="col-md-12">
              <label for="CoverImageUrl" class="form-label">Cover Image URL</label>
              <input type="url"
                     class="form-control form-control-sm"
                     name="CoverImageUrl"
                     id="CoverImageUrl"
                     title="Paste a URL of an image/photo for this Trip"
                     value="@Model.CoverImageUrl"
                     placeholder="https://...">
  
              @if (!string.IsNullOrWhiteSpace(Model.CoverImageUrl))
              {
                <div class="mt-2">
                  <a href="@Model.CoverImageUrl" target="_blank" rel="noopener noreferrer" title="Open full image in new tab">
                    <img src="@Model.CoverImageUrl"
                         class="img-fluid rounded shadow-sm"
                         alt="Trip Cover Preview"
                         title="Trip Cover Preview click to open image in new tab"
                         style="max-height: 150px;" />
                  </a>
                </div>
              }
            </div>

            <div class="col-md-12 d-flex gap-2">
              <input type="hidden" name="submitAction" id="submitAction" value="save" />

              <button id="btn-save-trip" type="button" class="btn btn-sm btn-primary">
                <i class="bi bi-save"></i> Save & Exit
              </button>

              <button id="btn-save-edit-trip" type="button" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-pencil-square"></i> Save & Continue
              </button>

              <a asp-area="User"
                 asp-controller="Trip"
                 asp-action="Index"
                 class="btn btn-sm btn-outline-dark">
                <i class="bi bi-arrow-left-circle"></i> Back to Trips
              </a>
            </div>


          </form>
        </div>

        <hr/>
        
        <!-- Region Area -->

        <h6>Regions &amp; Places</h6>
        <button id="btn-add-region" class="btn btn-sm btn-success mb-2">
          <i class="bi bi-plus-lg"></i> Add Region
        </button>

        <div id="regions-accordion" class="accordion mb-4">
          @if (!regions.Any())
          {
            <div class="alert alert-info" role="alert">
              No regions created yet.
            </div>
          }
          else
          {
            @foreach (var region in regions.OrderBy(r => r.DisplayOrder))
            {
              <!-- Place Area -->
              @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_RegionItemPartial.cshtml", region)
            }
          }
        </div>


        <hr/>

        <!-- Segments Area -->
        <h6>Segments</h6>
        <button id="btn-add-segment" class="btn btn-sm btn-success mb-2">
          <i class="bi bi-plus-lg"></i> Add Segment
        </button>

        <div>
          @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_SegmentListPartial.cshtml", Model)
        </div>

        
      </div>
    </div>

    <div>

    </div>
  </div>

  <div class="col-9">

    <div class="row">
      <div class="col-12 ">
        <div class="bg-white shadow rounded p-2 my-2 trip-searchbar">
          <div class="input-group flex-grow-1">
            @* <button id="btn-toggle-sidebar" class="btn btn-sm btn-outline-secondary z-3" type="button" *@
            @*         title="Toggle the left sidebar" *@
            @*         data-bs-toggle="collapse" data-bs-target="#sidebar" aria-expanded="true" aria-controls="sidebar"> *@
            @*   <i class="bi bi-layout-sidebar-inset"></i> Sidebar *@
            @* </button> *@
            <input id="place-search" type="text" class="form-control" placeholder="Search for places…"/>
            <button id="btn-search" class="btn btn-outline-secondary"><i class="bi bi-search"></i></button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div id="mapping-context-banner" class="alert alert-primary px-3 py-2 small rounded shadow-sm mb-2 d-flex justify-content-between align-items-center" role="alert">
          <i class="bi bi-pencil me-1"></i>
          <span id="mapping-context-text">Selected: —</span>
          <span id="context-coords" class="ms-2 text-muted d-none">
            <code class="user-select-all"></code>
          </span>
          <button id="btn-clear-context"
                  type="button"
                  class="btn-close btn-close-primary btn-sm ms-auto"
                  aria-label="Clear mapping context"
                  title="Clear selection"></button>
        </div>
        <div id="mapContainer" style="height: calc(100vh - 235px); width: 100%;"></div>
      </div>
    </div>

  </div>

  <!-- Modal for image URL input -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Insert Image URL</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="imageUrl" class="form-label">Image URL</label>
          <input type="text" id="imageUrl" class="form-control" placeholder="Enter the image URL here">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="insertImageBtn" class="btn btn-primary">Insert Image</button>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <partial name="_ValidationScriptsPartial"/>
  <script type="module" src="~/js/Areas/User/Trip/trip.js" asp-append-version="true"></script>
}