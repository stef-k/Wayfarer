@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model Wayfarer.Models.Trip

@{
  ViewData["LoadLeaflet"] = true;
  ViewData["LoadQuill"] = true;
  Layout = "~/Views/Shared/_Layout.cshtml";
  var regions = Model.Regions ?? new List<Region>();
  ViewData["BodyClass"] = "container-fluid";
  var visibleRegions = regions
    .Where(r => r.Name != "Unassigned Places" || (r.Places != null && r.Places.Any()))
    .ToList();
  
  var shadowRegion = regions.FirstOrDefault(r => r.Name == "Unassigned Places");
}

<div class="row">
  <div class="col-3">

    <div id="sidebar" class="show collapse-horizontal d-flex flex-column">
      <!-- Sidebar Header -->
      <div id="sidebarHeader" class="p-3 border-bottom d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Trip Settings</h5>

        <div class="d-flex align-items-center gap-2">
          <button type="button"
                  id="btn-trip-recenter"
                  class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-1"
                  title="Recenter map to saved trip view">
            <i class="bi bi-geo-alt-fill"></i>
            <span class="d-none d-md-inline">Map</span>
          </button>

          <button class="btn btn-link p-0" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#tripSettingsCollapse"
                  aria-expanded="true"
                  aria-controls="tripSettingsCollapse">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>


      <!-- Sidebar Content -->
      <div id="sidebarContent" class="flex-grow-1 overflow-y-auto p-3">
        <div class="collapse show" id="tripSettingsCollapse">
          <form id="trip-form" class="row g-3 mb-4">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id"/>
            <input type="hidden" asp-for="Id" id="trip-id"/>
            <input type="hidden" asp-for="CenterLat" data-default="@Model.CenterLat?.ToString("F6")"/>
            <input type="hidden" asp-for="CenterLon" data-default="@Model.CenterLon?.ToString("F6")"/>
            <input type="hidden" asp-for="Zoom" data-default="@Model.Zoom"/>
            <input type="hidden" id="shadow-region-id" value="@shadowRegion.Id" />
            <div class="col-md-12">
              <span class="text-muted small">Last updated at @Model.UpdatedAt.ToLongDateString()</span>
            </div>
            <div class="col-md-12">
              <label asp-for="Name" class="form-label"></label>
              <input asp-for="Name" class="form-control"/>
              <div class="invalid-feedback" asp-validation-for="Name"></div>
            </div>
            <div class="col-md-6 align-self-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="isPublicSwitch" asp-for="IsPublic">
                <label class="form-check-label" for="isPublicSwitch">Make Trip Public</label>
                <div class="invalid-feedback" asp-validation-for="IsPublic"></div>
              </div>
            </div>
            <div class="col-md-12">
              <label for="notes">Notes</label>
              <div id="notes" data-notes-content="@Model.Notes"></div>
              <input type="hidden" asp-for="Notes" id="Notes"/>
              <small class="text-muted">
                You cannot paste images in here. Use the image button from the toolbar to insert an image from a URL.
              </small>
              <div class="invalid-feedback" asp-validation-for="Notes"></div>
            </div>
            <div class="col-md-12">
              <label for="CoverImageUrl" class="form-label">Cover Image URL</label>
              <input type="url"
                     class="form-control form-control-sm"
                     name="CoverImageUrl"
                     id="CoverImageUrl"
                     title="Paste a URL of an image/photo for this Trip"
                     value="@Model.CoverImageUrl"
                     placeholder="https://...">

              @if (!string.IsNullOrWhiteSpace(Model.CoverImageUrl))
              {
                <div class="mt-2 text-center">
                  <a href="@Model.CoverImageUrl" target="_blank" rel="noopener noreferrer"
                     title="Open full image in new tab">
                    <img src="@Model.CoverImageUrl"
                         class="img-fluid rounded shadow-sm"
                         alt="Trip Cover Preview"
                         title="Trip Cover Preview click to open image in new tab"
                         style="max-height: 150px;"/>
                  </a>
                </div>
              }
            </div>

            <div class="col-md-12 d-flex gap-2">
              <input type="hidden" name="submitAction" id="submitAction" value="save"/>

              <button id="btn-save-trip" type="button" class="btn btn-sm btn-primary">
                <i class="bi bi-save"></i> Save & Exit
              </button>

              <button id="btn-save-edit-trip" type="button" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-pencil-square"></i> Save & Continue
              </button>

              <a asp-area="User"
                 asp-controller="Trip"
                 asp-action="Index"
                 class="btn btn-sm btn-outline-dark">
                <i class="bi bi-arrow-left-circle"></i> Back to Trips
              </a>
            </div>


          </form>
        </div>

        <hr/>

        <!-- Region Area -->

        <h6>Regions &amp; Places</h6>
        <button id="btn-add-region" class="btn btn-sm btn-success mb-2">
          <i class="bi bi-plus-lg"></i> Add Region
        </button>

        <div id="regions-accordion" class="accordion mb-4">
          @if (!visibleRegions.Any())
          {
            <div class="alert alert-info" role="alert">
              No regions created yet.
            </div>
          }
          else
          {
            @foreach (var region in regions
                        .Where(r => r.Name != "Unassigned Places" || (r.Places != null && r.Places.Any()))
                        .OrderBy(r => r.DisplayOrder))
            {
              @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_RegionItemPartial.cshtml", region)
            }
          }
        </div>

        <hr/>

        <!-- Segments Area -->
        <button id="btn-add-segment" class="btn btn-sm btn-success mb-2">
          <i class="bi bi-plus-lg"></i> Add Segment
        </button>

        <div id="segments-list" class="accordion mb-4">
          <div class="accordion-item" id="segments-container">
            <h2 class="accordion-header" id="heading-segments">
              <div class="d-flex justify-content-between align-items-center w-100">
                <button class="accordion-button collapsed flex-grow-1 text-start"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse-segments"
                        aria-expanded="false"
                        aria-controls="collapse-segments">
                  <strong>Segments</strong>
                </button>
                <!-- Segment Master Visibility Toggle -->
                <div class="d-flex align-items-center gap-2">
                  <div class="form-check mb-0 mx-2">
                    <input class="form-check-input"
                           type="checkbox"
                           id="toggle-all-segments"
                           title="Show/Hide all segments on map"
                           checked
                           aria-label="Toggle all segments visibility"/>
                  </div>
                </div>
              </div>
            </h2>

            <div id="collapse-segments" class="accordion-collapse collapse show" aria-labelledby="heading-segments"
                 data-bs-parent="#segments-list">

              <ul id="segments-inner-list" class="list-group list-group-flush small mb-0 ps-0">

                @if (Model.Segments == null || !Model.Segments.Any())
                {
                  <li class="alert alert-info p-2 small mb-2">
                    <i class="bi bi-info-circle me-1"></i> No travel segments added yet.
                  </li>
                }
                else
                {
                  @foreach (var segment in Model.Segments.OrderBy(s => s.DisplayOrder))
                  {
                    @await Html.PartialAsync("~/Areas/User/Views/Trip/Partials/_SegmentItemPartial.cshtml", segment)
                  }
                }

              </ul>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>

  <div class="col-9">
    <!-- ðŸ” Search + ðŸ§­ Coordinates -->
    <div class="row g-2 align-items-end mb-2">

      <!-- ðŸ” Search -->
      <div class="col-lg-6 col-md-12">
        <label for="place-search" class="form-label visually-hidden">Search</label>
        <div class="position-relative">
          <div class="input-group flex-grow-1 bg-white shadow rounded p-2 trip-searchbar">
            <input id="place-search" type="text" class="form-control" placeholder="Search for placesâ€¦"
                   title="Search any location. Click a result to preview it on the map."/>
          </div>
          <ul id="place-search-results" class="list-group zindex-tooltip">
          </ul>
        </div>
      </div>

      <!-- ðŸ§­ Latitude -->
      <div class="col-sm-3 col-6">
        <label for="contextLat" class="form-label visually-hidden">Lat</label>
        <div class="input-group bg-white shadow rounded p-2">
          <input type="number"
                 step="0.0000000000001"
                 class="form-control"
                 id="contextLat"
                 title="Insert latitude manually"
                 placeholder="Latitude"
                 autocomplete="off"/>
        </div>
      </div>

      <!-- ðŸ§­ Longitude -->
      <div class="col-sm-3 col-6">
        <label for="contextLon" class="form-label visually-hidden">Lon</label>
        <div class="input-group bg-white shadow rounded p-2">
          <input type="number"
                 step="0.0000000000001"
                 class="form-control"
                 id="contextLon"
                 title="Insert longitude manually"
                 placeholder="Longitude"
                 autocomplete="off"/>
        </div>
      </div>
    </div>

    <!-- ðŸ“Œ Context Banner -->
    <div class="row">
      <div class="col-12">
        <div id="mapping-context-banner"
             class="alert alert-primary px-3 py-2 small rounded shadow-sm mb-2 d-flex justify-content-between align-items-center"
             role="alert">
          <i class="bi bi-pencil me-1"></i>
          <span id="mapping-context-text">Selected: â€”</span>
          <span id="context-coords" class="ms-2 text-muted d-none">
            <code class="user-select-all"></code>
          </span>
          <button id="btn-clear-context"
                  type="button"
                  class="btn-close btn-close-primary btn-sm ms-auto"
                  aria-label="Clear mapping context"
                  title="Clear selection"></button>
        </div>
      </div>
    </div>

    <!-- ðŸ—ºï¸ Map -->
    <div class="row">
      <div class="col-12">
        <div id="mapContainer" style="height: calc(100vh - 235px); width: 100%;"></div>
      </div>
    </div>
  </div>


  <!-- Modal for image URL input -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Insert Image URL</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="imageUrl" class="form-label">Image URL</label>
          <input type="text" id="imageUrl" class="form-control" placeholder="Enter the image URL here">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="insertImageBtn" class="btn btn-primary">Insert Image</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add-place modal (no markup clash with existing ones) -->
<div class="modal fade" id="addPlaceModal" tabindex="-1" aria-labelledby="addPlaceModalLabel" aria-hidden="true">
  <div class="modal-dialog mt-5" style="max-width:420px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPlaceModalLabel">Add place to trip</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body d-flex flex-column gap-3">
        <select id="add-place-region-select" class="form-select"></select>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="btn-confirm-add-place" class="btn btn-success">
          <i class="bi bi-plus-circle me-1"></i>Add
        </button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    // whenever any Bootstrap modal is shown...
    document.addEventListener('shown.bs.modal', e => {
      // only care about your place-notes modals
      if (!e.target.id.startsWith('placeNotesModal-')) return;

      // find all images inside the modal body
      e.target.querySelectorAll('.modal-body img').forEach(img => {
        const orig = img.getAttribute('src');
        // skip proxying data-uris or images already proxied
        if (!orig || orig.startsWith('data:') || img.dataset.proxied) return;

        img.dataset.proxied  = 'true';
        img.dataset.original = orig;
        img.src              = `/Public/ProxyImage?url=${encodeURIComponent(orig)}`;
      });
    });
  </script>
  <partial name="_ValidationScriptsPartial"/>
  <script type="module" src="~/js/Areas/User/Trip/trip.js" asp-append-version="true"></script>
}