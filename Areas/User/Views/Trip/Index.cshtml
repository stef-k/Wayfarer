@model List<Wayfarer.Models.Trip>

@{
    ViewData["LoadLeaflet"] = true;
}

<h2>@ViewData["Title"]</h2>

<div class="d-flex gap-2 mb-3">
    <a asp-area="User" asp-controller="Trip" asp-action="Create"
       class="btn btn-primary" title="Create a new Trip">
        <i class="bi bi-plus-lg me-1"></i> Create New Trip
    </a>

    <label class="btn btn-outline-secondary mb-0" title="Import a Trip from a Wayfarer extended KML file (*.kml)">
        <i class="bi bi-upload me-1"></i> Import Trip&nbsp;
        <input type="file"
               id="importFile"
               accept=".kml"
               class="d-none">
    </label>

    <label class="btn btn-outline-secondary mb-0" title="Import a Google My Maps KML">
        <i class="bi bi-upload me-1"></i> Import My Maps
        <input type="file" id="importFileMyMaps" accept=".kml" class="d-none">
    </label>
</div>

@if (!Model.Any())
{
    <p>You don't have any trips yet.</p>
}
else
{
    <table class="table table-bordered table-striped table-hover">
        <thead>
        <tr>
            <th class="w-auto">Name</th>
            <th class="w-auto">Notes</th>
            <th class="w-auto">Public</th>
            <th class="w-25">Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var trip in Model)
        {
            <tr>
                <td>@trip.Name</td>
                <td>
                    @{
                        var notesPreview = trip.Notes;
                        if (!string.IsNullOrWhiteSpace(notesPreview))
                        {
                            // Strip all HTML tags for display in table
                            notesPreview = System.Text.RegularExpressions.Regex.Replace(notesPreview, "<.*?>", string.Empty);
                            // Truncate to 100 characters
                            if (notesPreview.Length > 100)
                            {
                                notesPreview = notesPreview.Substring(0, 97) + "...";
                            }
                        }
                    }
                    @notesPreview
                </td>
                <td>
                    @if (trip.IsPublic)
                    {
                        <div class="dropdown text-center">
                            <button class="btn btn-success btn-sm dropdown-toggle"
                                    type="button"
                                    data-bs-display="static"
                                    data-bs-toggle="dropdown"
                                    title="Click to see public page or for copy URL options"
                                    aria-expanded="false">
                                Yes
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" 
                                       href="/Public/Trips/@trip.Id"
                                       target="_blank">Visit public trip page</a></li>
                                <li>
                                    <a class="dropdown-item copy-url" 
                                       href="#"
                                       data-url="/Public/Trips/@trip.Id"
                                       title="Click to copy to clipboard">
                                        Copy public trip page URL
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item copy-url"
                                       href="#"
                                       data-url="/Public/Trips/@trip.Id?embed=true"
                                       title="Click to copy to clipboard">
                                        Copy public trip page embed
                                    </a>
                                </li>
                            </ul>
                        </div>
                    }
                    else
                    {
                        <span class="badge rounded-pill text-bg-danger">No</span>
                    }
                </td>
                <td>
                    <a asp-area="User" asp-controller="Trip" asp-action="View" title="View/Export Trip"
                       asp-route-id="@trip.Id"
                       class="btn btn-sm btn-primary">View</a>
                    <a asp-area="User" asp-controller="Trip" asp-action="Edit" title="Edit Trip" asp-route-id="@trip.Id"
                       class="btn btn-sm btn-secondary">Edit</a>
                    <div class="dropdown d-inline-block">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                type="button"
                                data-bs-toggle="dropdown"
                                data-bs-display="static"
                                aria-expanded="false">
                            More
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item btn-backfill-analyze"
                                   href="#"
                                   data-trip-id="@trip.Id"
                                   data-trip-name="@trip.Name"
                                   title="Scan your location history to find and create visit records for places in this trip">
                                    <i class="bi bi-clock-history me-2"></i>Analyze History
                                    <small class="d-block text-muted ps-4">Find visits from your location data</small>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item btn-backfill-clear text-warning"
                                   href="#"
                                   data-trip-id="@trip.Id"
                                   data-trip-name="@trip.Name"
                                   title="Remove all visit records associated with this trip">
                                    <i class="bi bi-trash me-2"></i>Clear All Visits
                                    <small class="d-block text-muted ps-4">Delete all visit records for this trip</small>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger btn-trip-delete"
                                   href="#"
                                   data-trip-id="@trip.Id">
                                    <i class="bi bi-x-circle me-2"></i>Delete Trip
                                </a>
                            </li>
                        </ul>
                    </div>
                    <form id="delete-form-@trip.Id"
                          asp-action="Delete"
                          method="post"
                          class="d-none">
                        <input type="hidden" name="id" value="@trip.Id"/>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<!-- ▼ Backfill analysis modal -->
<div class="modal fade" id="backfillModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history me-2"></i>Analyze Location History
                    <i class="bi bi-question-circle text-muted ms-2 backfill-help" role="button" tabindex="0"
                       data-tippy-content="This tool scans your location history to find days when you were physically near places in this trip. It can automatically create visit records for places you've been to, and identify outdated visits that may need cleanup."></i>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Configuration Phase -->
                <div id="backfill-config">
                    <p class="mb-3">
                        Analyzing trip: <strong id="backfill-trip-name"></strong>
                    </p>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="backfill-from-date" class="form-label">
                                From Date (optional)
                                <i class="bi bi-question-circle text-muted small backfill-help" role="button" tabindex="0"
                                   data-tippy-content="Only analyze location history from this date forward. Useful if you know when your trip started."></i>
                            </label>
                            <input type="date" class="form-control" id="backfill-from-date">
                        </div>
                        <div class="col-md-6">
                            <label for="backfill-to-date" class="form-label">
                                To Date (optional)
                                <i class="bi bi-question-circle text-muted small backfill-help" role="button" tabindex="0"
                                   data-tippy-content="Only analyze location history up to this date. Useful if you know when your trip ended."></i>
                            </label>
                            <input type="date" class="form-control" id="backfill-to-date">
                        </div>
                    </div>
                    <div class="alert alert-light small mb-0">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>How it works:</strong> The analysis searches your location history for GPS points
                        within ~150m of each place in this trip. Days with multiple location points near a place
                        are suggested as visits. Leave dates empty to scan your entire history.
                    </div>
                </div>

                <!-- Loading Phase -->
                <div id="backfill-loading" class="text-center py-4 d-none">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Analyzing...</span>
                    </div>
                    <p class="mb-0">Analyzing location history...</p>
                </div>

                <!-- Results Phase -->
                <div id="backfill-results" class="d-none">
                    <!-- Summary -->
                    <div class="alert alert-info mb-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="fw-bold" id="result-locations">0</div>
                                <small class="text-muted backfill-help" role="button" tabindex="0"
                                       data-tippy-content="Total GPS location points that matched places in this trip. More matches = higher confidence.">
                                    Locations <i class="bi bi-info-circle"></i>
                                </small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold" id="result-places">0</div>
                                <small class="text-muted backfill-help" role="button" tabindex="0"
                                       data-tippy-content="Number of places in this trip that have coordinates and were included in the analysis.">
                                    Places <i class="bi bi-info-circle"></i>
                                </small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold" id="result-time">0ms</div>
                                <small class="text-muted">Analysis Time</small>
                            </div>
                        </div>
                    </div>

                    <!-- Search filter (shown with results) -->
                    <div id="backfill-search-wrapper" class="mb-2 d-none">
                        <div class="backfill-search-group">
                            <input type="text" class="form-control form-control-sm pe-4"
                                   id="backfill-search" placeholder="Search places, regions...">
                            <button type="button" class="btn-search-clear d-none"
                                    id="backfill-search-clear" title="Clear search">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs" id="backfillTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed-pane"
                                    type="button" role="tab" aria-controls="confirmed-pane" aria-selected="true">
                                <i class="bi bi-plus-circle text-success me-1"></i>
                                Confirmed <span class="badge bg-success ms-1" id="new-visits-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="suggestions-tab" data-bs-toggle="tab" data-bs-target="#suggestions-pane"
                                    type="button" role="tab" aria-controls="suggestions-pane" aria-selected="false">
                                <i class="bi bi-lightbulb text-info me-1"></i>
                                Consider Also <span class="badge bg-info ms-1" id="suggested-visits-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stale-tab" data-bs-toggle="tab" data-bs-target="#stale-pane"
                                    type="button" role="tab" aria-controls="stale-pane" aria-selected="false">
                                <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                Stale <span class="badge bg-warning text-dark ms-1" id="stale-visits-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="existing-tab" data-bs-toggle="tab" data-bs-target="#existing-pane"
                                    type="button" role="tab" aria-controls="existing-pane" aria-selected="false">
                                <i class="bi bi-check-circle text-primary me-1"></i>
                                Existing <span class="badge bg-primary ms-1" id="existing-visits-count">0</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content pt-3" id="backfillTabContent">
                        <!-- Confirmed (New Visits) Tab -->
                        <div class="tab-pane fade show active" id="confirmed-pane" role="tabpanel" aria-labelledby="confirmed-tab">
                            <div id="new-visits-hint" class="alert alert-success small py-2 mb-2 d-none">
                                <i class="bi bi-check-circle me-1"></i>
                                These visits will be <strong>automatically created</strong> when you click Apply.
                                Higher confidence means more GPS points were found near the place.
                                <i class="bi bi-question-circle text-muted ms-1 backfill-help" role="button" tabindex="0"
                                   data-tippy-content="<strong>Confirmed visits</strong> are days when your location history shows you were near a place (within ~150m), with multiple GPS points confirming your presence.<br><br><strong>Confidence %</strong> indicates certainty — based on how many GPS points matched and how close they were to the place center."></i>
                            </div>
                            <div id="new-visits-list" class="list-group list-group-flush" style="max-height: min(50vh, 500px); overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                            <div id="no-new-visits" class="text-muted small d-none">
                                <i class="bi bi-check-circle me-1"></i>
                                No new visits found — you may already have visit records for all matching days,
                                or no location data matches the places in this trip.
                            </div>
                        </div>

                        <!-- Consider Also (Suggestions) Tab -->
                        <div class="tab-pane fade" id="suggestions-pane" role="tabpanel" aria-labelledby="suggestions-tab">
                            <div id="suggested-visits-hint" class="alert alert-info small py-2 mb-2 d-none">
                                <i class="bi bi-lightbulb me-1"></i>
                                These are <strong>potential visits</strong> that didn't meet strict matching criteria but show evidence
                                you may have been nearby. Check the ones you want to confirm.
                                <i class="bi bi-question-circle text-muted ms-1 backfill-help" role="button" tabindex="0"
                                   data-tippy-content="<strong>Consider Also</strong> shows places where your location data suggests a possible visit:<br><br>• <strong>Cross-tier evidence</strong> — GPS points at multiple distances (e.g., some within 150m, more within 300m)<br>• <strong>User check-in</strong> — You manually checked in while nearby<br>• <strong>Extended range</strong> — Multiple pings within a wider area<br><br>These require your confirmation — check to create a visit, leave unchecked to skip."></i>
                            </div>
                            <div id="suggested-select-all-wrapper" class="d-flex justify-content-end mb-2 d-none">
                                <a href="#" class="small text-decoration-none" id="suggested-select-all">Select all</a>
                                <span class="text-muted mx-1">|</span>
                                <a href="#" class="small text-decoration-none" id="suggested-deselect-all">Deselect all</a>
                            </div>
                            <div id="suggested-visits-list" class="list-group list-group-flush" style="max-height: min(50vh, 500px); overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                            <div id="no-suggested-visits" class="text-muted small d-none">
                                <i class="bi bi-check-circle me-1"></i>
                                No additional suggestions — all potential visits either met strict criteria (shown in Confirmed tab)
                                or had insufficient evidence.
                            </div>
                        </div>

                        <!-- Stale Visits Tab -->
                        <div class="tab-pane fade" id="stale-pane" role="tabpanel" aria-labelledby="stale-tab">
                            <div id="stale-visits-hint" class="alert alert-warning small py-2 mb-2 d-none">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                <strong>Checked visits will be deleted.</strong> These visits reference places that were
                                deleted or moved significantly. Uncheck any you want to keep.
                                <i class="bi bi-question-circle text-muted ms-1 backfill-help" role="button" tabindex="0"
                                   data-tippy-content="<strong>Stale visits</strong> are existing visit records that may no longer be accurate:<br><br>• <strong>Place was deleted</strong> — The place no longer exists<br>• <strong>Place was moved</strong> — The place location changed significantly (>150m) since the visit was recorded<br><br>These are pre-selected for deletion, but you can uncheck any you want to keep."></i>
                            </div>
                            <div id="stale-select-all-wrapper" class="d-flex justify-content-end mb-2 d-none">
                                <a href="#" class="small text-decoration-none" id="stale-select-all">Select all</a>
                                <span class="text-muted mx-1">|</span>
                                <a href="#" class="small text-decoration-none" id="stale-deselect-all">Deselect all</a>
                            </div>
                            <div id="stale-visits-list" class="list-group list-group-flush" style="max-height: min(50vh, 500px); overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                            <div id="no-stale-visits" class="text-muted small d-none">
                                <i class="bi bi-check-circle me-1"></i>
                                No stale visits found — all existing visits reference valid, current place locations.
                            </div>
                        </div>

                        <!-- Existing Visits Tab -->
                        <div class="tab-pane fade" id="existing-pane" role="tabpanel" aria-labelledby="existing-tab">
                            <div id="existing-visits-hint" class="alert alert-secondary small py-2 mb-2 d-none">
                                <i class="bi bi-shield-check me-1"></i>
                                These are <strong>valid visits</strong> that won't be modified unless you check them for deletion.
                                Use this to manually clean up visits you no longer want.
                                <i class="bi bi-question-circle text-muted ms-1 backfill-help" role="button" tabindex="0"
                                   data-tippy-content="<strong>Existing visits</strong> are valid visit records that already exist for this trip. They are shown here for reference and manual cleanup.<br><br>Check any visits you want to delete — for example, if they were created by mistake or you want to re-analyze with different settings."></i>
                            </div>
                            <div id="existing-select-all-wrapper" class="d-flex justify-content-end mb-2 d-none">
                                <a href="#" class="small text-decoration-none" id="existing-select-all">Select all</a>
                                <span class="text-muted mx-1">|</span>
                                <a href="#" class="small text-decoration-none" id="existing-deselect-all">Deselect all</a>
                            </div>
                            <div id="existing-visits-list" class="list-group list-group-flush" style="max-height: min(50vh, 500px); overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                            <div id="no-existing-visits" class="text-muted small d-none">
                                <i class="bi bi-inbox me-1"></i>
                                No existing visits for this trip yet.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Action Summary (shown before Apply) -->
            <div id="action-summary" class="px-3 pb-2 d-none">
                <div class="alert alert-light border mb-0 small">
                    <strong>Actions to perform:</strong>
                    <ul class="mb-0 ps-3">
                        <li id="summary-create" class="d-none"><span id="summary-create-count">0</span> confirmed visits will be created</li>
                        <li id="summary-confirm-suggestions" class="d-none text-info"><span id="summary-confirm-count">0</span> suggested visits will be created</li>
                        <li id="summary-delete-stale" class="d-none text-warning"><span id="summary-delete-stale-count">0</span> stale visits will be deleted</li>
                        <li id="summary-delete-manual" class="d-none text-danger"><span id="summary-delete-manual-count">0</span> existing visits will be deleted</li>
                        <li id="summary-nothing" class="d-none text-muted">No changes to apply</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-backfill-analyze">
                    <i class="bi bi-search me-1"></i>Analyze
                </button>
                <button type="button" class="btn btn-success d-none" id="btn-backfill-apply">
                    <i class="bi bi-check-lg me-1"></i>Apply Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ▼ NEW duplicate / upsert modal -->
<div class="modal fade" id="dupModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">Trip already exists</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                A trip with the same ID is already in your account.
                <br/>What would you like to do?
            </div>
            <div class="modal-footer">
                <button id="btnUpdate" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat me-1"></i> Update existing
                </button>
                <button id="btnCopy" class="btn btn-outline-secondary">
                    <i class="bi bi-files me-1"></i> Create copy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ▼ Place Context Map modal (stacked above backfill modal) -->
<div class="modal fade" id="placeContextModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header py-2">
                <h5 class="modal-title" id="placeContextTitle">
                    <i class="bi bi-geo-alt me-1"></i>Place Context
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="placeContextMap"></div>
                <div id="placeContextInfo" class="p-3 border-top small">
                    <div class="row text-center">
                        <div class="col">
                            <div class="fw-bold" id="context-ping-count">-</div>
                            <small class="text-muted">Location Pings</small>
                        </div>
                        <div class="col">
                            <div class="fw-bold" id="context-time-range">-</div>
                            <small class="text-muted">Time Range</small>
                        </div>
                        <div class="col">
                            <div class="fw-bold" id="context-avg-distance">-</div>
                            <small class="text-muted">Avg Distance</small>
                        </div>
                        <div class="col">
                            <div class="fw-bold" id="context-closest-ping">-</div>
                            <small class="text-muted">Closest Ping</small>
                        </div>
                        <div class="col">
                            <div class="fw-bold" id="context-furthest-ping">-</div>
                            <small class="text-muted">Furthest Ping</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <div class="me-auto d-flex align-items-center gap-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Click the ruler icon <i class="bi bi-rulers"></i> to measure distances
                    </small>
                    <span id="context-external-links"></span>
                </div>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    @Html.FrontendViewScripts()
}