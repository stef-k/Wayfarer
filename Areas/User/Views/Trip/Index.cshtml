@model List<Wayfarer.Models.Trip>


<h2>@ViewData["Title"]</h2>

<div class="d-flex gap-2 mb-3">
    <a asp-area="User" asp-controller="Trip" asp-action="Create"
       class="btn btn-primary" title="Create a new Trip">
        <i class="bi bi-plus-lg me-1"></i> Create New Trip
    </a>

    <label class="btn btn-outline-secondary mb-0" title="Import a Trip from a Wayfarer extended KML file (*.kml)">
        <i class="bi bi-upload me-1"></i> Import Trip&nbsp;
        <input type="file"
               id="importFile"
               accept=".kml"
               class="d-none">
    </label>

    <label class="btn btn-outline-secondary mb-0" title="Import a Google My Maps KML">
        <i class="bi bi-upload me-1"></i> Import My Maps
        <input type="file" id="importFileMyMaps" accept=".kml" class="d-none">
    </label>
</div>

@if (!Model.Any())
{
    <p>You don't have any trips yet.</p>
}
else
{
    <table class="table table-bordered table-striped table-hover">
        <thead>
        <tr>
            <th class="w-auto">Name</th>
            <th class="w-auto">Notes</th>
            <th class="w-auto">Public</th>
            <th class="w-25">Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var trip in Model)
        {
            <tr>
                <td>@trip.Name</td>
                <td>
                    @{
                        var notesPreview = trip.Notes;
                        if (!string.IsNullOrWhiteSpace(notesPreview))
                        {
                            // Strip all HTML tags for display in table
                            notesPreview = System.Text.RegularExpressions.Regex.Replace(notesPreview, "<.*?>", string.Empty);
                            // Truncate to 100 characters
                            if (notesPreview.Length > 100)
                            {
                                notesPreview = notesPreview.Substring(0, 97) + "...";
                            }
                        }
                    }
                    @notesPreview
                </td>
                <td>
                    @if (trip.IsPublic)
                    {
                        <div class="dropdown text-center">
                            <button class="btn btn-success btn-sm dropdown-toggle"
                                    type="button"
                                    data-bs-display="static"
                                    data-bs-toggle="dropdown"
                                    title="Click to see public page or for copy URL options"
                                    aria-expanded="false">
                                Yes
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" 
                                       href="/Public/Trips/@trip.Id"
                                       target="_blank">Visit public trip page</a></li>
                                <li>
                                    <a class="dropdown-item copy-url" 
                                       href="#"
                                       data-url="/Public/Trips/@trip.Id"
                                       title="Click to copy to clipboard">
                                        Copy public trip page URL
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item copy-url"
                                       href="#"
                                       data-url="/Public/Trips/@trip.Id?embed=true"
                                       title="Click to copy to clipboard">
                                        Copy public trip page embed
                                    </a>
                                </li>
                            </ul>
                        </div>
                    }
                    else
                    {
                        <span class="badge rounded-pill text-bg-danger">No</span>
                    }
                </td>
                <td>
                    <a asp-area="User" asp-controller="Trip" asp-action="View" title="View/Export Trip"
                       asp-route-id="@trip.Id"
                       class="btn btn-sm btn-primary">View</a>
                    <a asp-area="User" asp-controller="Trip" asp-action="Edit" title="Edit Trip" asp-route-id="@trip.Id"
                       class="btn btn-sm btn-secondary">Edit</a>
                    <form id="delete-form-@trip.Id"
                          asp-action="Delete"
                          method="post"
                          class="d-none">
                        <input type="hidden" name="id" value="@trip.Id"/>
                    </form>

                    <button type="button"
                            class="btn btn-sm btn-outline-danger btn-trip-delete"
                            data-trip-id="@trip.Id"
                            title="Delete Trip">
                        Delete
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<!-- â–¼ NEW duplicate / upsert modal -->
<div class="modal fade" id="dupModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">Trip already exists</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                A trip with the same ID is already in your account.
                <br/>What would you like to do?
            </div>
            <div class="modal-footer">
                <button id="btnUpdate" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat me-1"></i> Update existing
                </button>
                <button id="btnCopy" class="btn btn-outline-secondary">
                    <i class="bi bi-files me-1"></i> Create copy
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    @Html.FrontendViewScripts()
}