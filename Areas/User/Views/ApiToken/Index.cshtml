@using System.Net
@model Wayfarer.Models.ViewModels.ApiTokenViewModel

@{
    // ZERO CONFIGURATION: Universal URL generation for any self-hosted Wayfarer instance
    // No appsettings.json entries needed - pure automatic detection

    var scheme = DetermineScheme(Context);
    var host = Context.Request.Host.ToString();

    var serverBaseUrl = $"{scheme}://{host}";
    var fullurl = $"{serverBaseUrl}/api/location/log-location";

    // Automatic scheme detection - no configuration required
    string DetermineScheme(HttpContext context)
    {
        // 1. If already HTTPS (direct HTTPS connection), use HTTPS
        if (context.Request.IsHttps)
        {
            return "https";
        }

        // 2. Check reverse proxy headers (nginx, Apache, etc.)
        var forwardedProto = context.Request.Headers["X-Forwarded-Proto"].FirstOrDefault() ?? "";
        if (forwardedProto.Equals("https", StringComparison.OrdinalIgnoreCase))
        {
            return "https";
        }

        // 3. Check alternative proxy headers
        var forwardedSsl = context.Request.Headers["X-Forwarded-Ssl"].FirstOrDefault() ?? "";
        if (forwardedSsl.Equals("on", StringComparison.OrdinalIgnoreCase))
        {
            return "https";
        }

        // 4. Automatic environment detection (no config needed)
        var hostName = context.Request.Host.Host.ToLower();

        // LOCAL DEVELOPMENT: Use HTTP
        if (IsLocalDevelopment(hostName))
        {
            return "http";
        }

        // PRODUCTION INDICATORS: Use HTTPS
        if (HasProductionIndicators(context, hostName))
        {
            return "https";
        }

        // FALLBACK: Use original scheme
        return context.Request.Scheme;
    }

    // Detect local development - no configuration needed
    bool IsLocalDevelopment(string hostName)
    {
        return hostName.Equals("localhost", StringComparison.OrdinalIgnoreCase) ||
               hostName.Equals("127.0.0.1") ||
               hostName.Equals("0.0.0.0") ||
               hostName.Equals("::1") ||
               hostName.StartsWith("192.168.") || // Private network
               hostName.StartsWith("10.") || // Private network
               hostName.StartsWith("172.") || // Private network/Docker
               hostName.EndsWith(".local") || // .local TLD
               hostName.EndsWith(".localhost") || // .localhost TLD
               IsPrivateIpAddress(hostName);
    }

    // Detect production environment - no configuration needed
    bool HasProductionIndicators(HttpContext context, string hostName)
    {
        // INDICATOR 1: Environment variable
        var environment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "";
        if (environment.Equals("Production", StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        // INDICATOR 2: Standard HTTP/HTTPS ports
        var port = context.Request.Host.Port ?? 0;
        if (port == 443 || port == 80)
        {
            return true; // Standard web ports suggest production
        }

        // INDICATOR 3: Real domain name (not localhost/IP)
        if (hostName.Contains(".") &&
            !hostName.StartsWith("192.168.") &&
            !hostName.StartsWith("10.") &&
            !hostName.StartsWith("172.") &&
            !hostName.Equals("127.0.0.1"))
        {
            return true; // Real domain suggests production
        }

        // INDICATOR 4: HTTPS configuration detected
        var httpsPort = Environment.GetEnvironmentVariable("ASPNETCORE_HTTPS_PORT");
        if (!string.IsNullOrEmpty(httpsPort))
        {
            return true;
        }

        return false;
    }

    // Check if hostname is a private IP - no configuration needed
    bool IsPrivateIpAddress(string hostName)
    {
        if (!IPAddress.TryParse(hostName, out var ip))
        {
            return false;
        }

        var bytes = ip.GetAddressBytes();
        return bytes[0] == 10 || // 10.0.0.0/8
               (bytes[0] == 172 && bytes[1] >= 16 && bytes[1] <= 31) || // 172.16.0.0/12
               (bytes[0] == 192 && bytes[1] == 168) || // 192.168.0.0/16
               bytes[0] == 127; // 127.0.0.0/8
    }
}

<!-- Include QR Code JavaScript Library -->
<script type="text/javascript" src="~/lib/davidshimjs-qrcodejs/qrcode.js"></script>

<h1 class="text-center">@ViewData["Title"] for @Model.UserName</h1>

@{
    // Check for newly created/regenerated token from TempData (one-time display)
    var newToken = TempData["NewToken"] as string;
    var newTokenName = TempData["NewTokenName"] as string;
}

@if (!string.IsNullOrEmpty(newToken))
{
    <div class="container">
        <div class="row">
            <div class="col-md-10 offset-1">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Important: Copy Your New Token Now!</h4>
                    <p>Your new API token for <strong>@newTokenName</strong> has been created. <strong>This is the only time it will be displayed.</strong></p>
                    <hr>
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <code id="new-token-display" class="border p-3 rounded bg-body-tertiary user-select-all flex-grow-1" style="font-size: 1.1em;">@newToken</code>
                        <button type="button" class="btn btn-primary" onclick="copyNewToken()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                    <p class="mb-0"><small>Make sure to save this token securely. You will need to update it in your Wayfarer Mobile app and any other integrations.</small></p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function copyNewToken() {
            const tokenText = document.getElementById('new-token-display').textContent;
            navigator.clipboard.writeText(tokenText).then(() => {
                wayfarer.showToast('success', 'Token copied to clipboard!', 3000);
            }).catch(err => {
                console.error('Failed to copy token:', err);
                wayfarer.showToast('danger', 'Failed to copy token. Please select and copy manually.', 3000);
            });
        }
    </script>
}

<div class="container">
    <div class="row">
        <div class="col-md-10 offset-1">
            <!-- Token List Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header text-bg-primary mb-3">
                    <h2>API Tokens</h2>
                </div>
                <div class="card-body">
                    @if (Model.Tokens != null && Model.Tokens.Any())
                    {
                        @foreach (var token in Model.Tokens)
                        {
                            @* Do not render token summary/actions in this panel; only render the integration sections for the main incoming token below. *@

                            @if (token.Name.Equals("Wayfarer Incoming Location Data API Token"))
                            {
                                <!-- Wayfarer Mobile App Integration Section -->
                                <div class="mt-4 mb-4">
                                    <h5><strong>üîó Wayfarer Mobile App Integration</strong></h5>
                                    <p class="mb-3">Use the QR code below to quickly configure your Wayfarer Mobile app.
                                        The QR code contains the complete server configuration including URL and API
                                        token.</p>

                                    <!-- Single QR Code -->
                                    <div class="row justify-content-center">
                                        <div class="col-md-6 mb-3">
                                            <div class="">
                                                <div class="d-none">
                                                    <h6 class="mb-0">üì± Wayfarer Mobile Configuration</h6>
                                                </div>
                                                <div>
                                                    <div id="qr-mobile-config" class="my-5 d-inline-block p-3 bg-white rounded"></div>
                                                    <div class="small text-muted">
                                                        <p><strong>Server:</strong> <code
                                                                class="border p-2 rounded bg-body-tertiary user-select-all">@serverBaseUrl</code>
                                                        </p>
                                                        <p class="d-flex align-items-center justify-content-between">
                                                            <span>
                                                                <strong>Token:</strong> <code id="wayfarer-token"
                                                                    class="border p-2 rounded bg-body-tertiary user-select-all">@(token.IsHashedToken ? token.DisplayToken : token.Token)</code>
                                                                @if (token.IsHashedToken)
                                                                {
                                                                    <small class="text-warning ms-2" title="Token is securely hashed. Regenerate to get a new token."><i class="bi bi-shield-lock"></i></small>
                                                                }
                                                            </span>
                                                            <button type="button"
                                                                    class="btn btn-warning btn-sm ms-2"
                                                                    onclick="regenerateWayfarerToken()"
                                                                    title="Regenerate API Token">
                                                                <i class="bi bi-arrow-clockwise"></i> Regenerate
                                                            </button>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Instructions -->
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            Quick Setup Instructions
                                        </h6>
                                        <ol class="mb-0">
                                            <li>Open the <strong>Wayfarer Mobile</strong> app on your device</li>
                                            <li>Navigate to <strong>Settings</strong></li>
                                            <li>Tap the <strong>üì∑ QR</strong> button next to either the Server URL or
                                                API Token field
                                            </li>
                                            <li>Scan the QR code above</li>
                                            <li>The app will automatically configure <strong>both</strong> the server
                                                URL and API token
                                            </li>
                                            <li>Tap <strong>"Refresh from Server"</strong> to test the connection</li>
                                        </ol>
                                    </div>
                                </div>

                                <!-- GPS Logger Integration Section -->
                                <div class="mt-4">
                                    <h5><strong>üìç Third-Party GPS Logger Integration</strong></h5>
                                    <p class="mb-3">Use with third-party mobile apps to log your location
                                        automatically.</p>

                                    <!-- Simple HTTP Endpoint -->
                                    <div class="card bg-body-tertiary mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">üì° Simple HTTP GET/POST Endpoint</h6>
                                            <p class="mb-2"><strong>URL:</strong></p>
                                            <code
                                                class="border p-2 rounded bg-body-tertiary d-block mb-3 user-select-all">@fullurl</code>

                                            <p class="mb-2"><strong>Required Parameters:</strong></p>
                                            <ul class="mb-2">
                                                <li><code>lat</code> - Latitude (decimal degrees)</li>
                                                <li><code>lon</code> - Longitude (decimal degrees)</li>
                                                <li><code>token</code> - Your API token (above)</li>
                                            </ul>

                                            <p class="mb-2"><strong>Optional Parameters:</strong></p>
                                            <ul class="mb-3">
                                                <li><code>speed</code> - Speed in m/s</li>
                                                <li><code>accuracy</code> - GPS accuracy in meters</li>
                                                <li><code>altitude</code> - Altitude in meters</li>
                                                <li><code>timestamp</code> - ISO 8601 timestamp</li>
                                                <li><code>notes</code> - Custom notes/description</li>
                                            </ul>

                                            <div class="alert alert-info mb-0">
                                                <small>
                                                    <strong>üí° Compatible Apps:</strong>
                                                    GPS Logger for Android, Owntracks, GPSies, and other apps that
                                                    support custom HTTP endpoints.
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Advanced JSON API -->
                                    <div class="card bg-body-tertiary">
                                        <div class="card-body">
                                            <h6 class="card-title">üîó Advanced JSON API (Bearer Token)</h6>
                                            <p class="mb-2"><strong>Endpoint:</strong> <code>@fullurl</code></p>
                                            <p class="mb-2"><strong>Method:</strong> POST</p>
                                            <p class="mb-2"><strong>Content-Type:</strong> <code>application/json</code>
                                            </p>
                                            <p class="mb-3"><strong>Authorization:</strong>
                                                <code>Bearer @(token.IsHashedToken ? "<your-token>" : token.Token)</code></p>

                                            <p class="mb-2">
                                                <strong>Required parameters:</strong> <code>latitude, longitude,
                                                    timestamp</code><br/>
                                                Note: <code>timestamp</code> should be the device's <strong>local
                                                    time</strong> (not UTC).<br/>
                                                Ensure <code>%TIME</code> is in <strong>ISO 8601</strong> format (e.g.,
                                                "2025-05-23T14:30:00").
                                            </p>

                                            <p class="mb-2"><strong><a href="https://gpslogger.app/"
                                                                       title="Read about GPSLogger" target="_blank">GPSLogger</a>
                                                    example:</strong></p>
                                            <ol class="mb-2">
                                                <li>Set HTTP Method to POST</li>
                                                <li>Add the following headers:</li>
                                                <ul>
                                                    <li><code>Content-Type: application/json</code></li>
                                                    <li><code>Authorization: Bearer @(token.IsHashedToken ? "<your-token>" : token.Token)</code></li>
                                                </ul>
                                                <li>Use the following JSON Template:</li>
                                            </ol>

                                            <pre class="bg-dark text-light p-3 rounded mb-0">
{
  "latitude": %LAT,
  "longitude": %LON,
  "timestamp": "%TIME",
  "accuracy": %ACC,
  "altitude": %ALT,
  "speed": %SPD
}
</pre>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <p>No API tokens found. Please create one.</p>
                    }
                </div>
            </div>

            <!-- Third Party Tokens Section (if any exist) -->
            @{
                var thirdPartyTokens = Model.Tokens?.Where(t => !t.Name.Equals("Wayfarer Incoming Location Data API Token")).ToList();
            }
            @if (thirdPartyTokens != null && thirdPartyTokens.Any())
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header text-bg-primary">
                        <h2>üåê Third Party API Tokens</h2>
                    </div>
                    <div class="card-body">
                        @foreach (var token in thirdPartyTokens)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <p class="mb-1"><strong>Service:</strong> @token.Name</p>
                                    <p class="mb-1"><strong>Created At:</strong> @token.CreatedAt</p>
                                    <p class="mb-0"><strong>Token:</strong> <code
                                            class="border p-2 rounded bg-body-tertiary user-select-all">@(token.IsHashedToken ? token.DisplayToken : token.Token)</code></p>
                                </div>
                                <div class="text-end">
                                    <!-- NO REGENERATE BUTTON - only delete -->
                                    <a href="@Url.Action("Delete", new { tokenId = token.Id })"
                                       class="btn btn-danger btn-sm">Delete</a>
                                    <small class="text-muted d-block mt-1">Regenerate via @token.Name</small>
                                </div>
                            </div>

                            @if (token.Name.Equals("Mapbox", StringComparison.OrdinalIgnoreCase))
                            {
                                <div class="alert alert-info mt-2 mb-3">
                                    <small>
                                        <strong>Purpose:</strong> Reverse geocoding (convert coordinates to
                                        addresses)<br/>
                                        <strong>Manage:</strong> <a href="https://account.mapbox.com/access-tokens/"
                                                                    target="_blank">Mapbox Dashboard</a>
                                    </small>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mt-2 mb-3">
                                    <small>
                                        <strong>Purpose:</strong> Third-party mapping and geocoding services<br/>
                                        <strong>Manage:</strong> Update tokens in your @token.Name dashboard
                                    </small>
                                </div>
                            }

                            @if (!thirdPartyTokens.Last().Equals(token))
                            {
                                <hr class="my-3"/>
                            }
                        }
                    </div>
                </div>
            }

            <!-- Store Third Party Token Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header text-bg-primary mb-3">
                    <h2>Store Third Party API Token</h2>
                </div>
                <div class="card-body">
                    <p>
                        Store API token from a third-party service.
                        For example, here you should store your Mapbox API token in order for reverse geocoding (get
                        addresses from coordinates) to work.
                    </p>
                    <p>Select a service from the dropdown, and then paste the corresponding token.</p>
                    <p>
                        <strong>Third Party Charges:</strong> You should have in mind that you may be charged if you
                        exceed usage limits from the service providers you use.
                        For example, Mapbox provides 100,000 free API calls per month. If Wayfarer logs your location
                        every 5 minutes, this will result in 8,640 API calls for reverse geocoding per month.
                    </p>
                    <form method="post" asp-action="StoreThirdPartyToken" asp-controller="ApiToken" asp-area="User">
                        <input type="hidden" name="id" value="@Model.UserId"/>

                        <div class="mb-3">
                            <label for="thirdPartyServiceName" class="form-label">Third Party Service Name:</label>
                            <select class="form-select" id="thirdPartyServiceName" name="thirdPartyServiceName"
                                    required>
                                <option value="">-- Select a Service --</option>
                                <option value="Mapbox">Mapbox</option>
                                @* <option value="GoogleMaps">Google Maps</option> *@
                                @* <option value="OpenCage">OpenCage</option> *@
                                @* <option value="HereMaps">HERE Maps</option> *@
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="thirdPartyToken" class="form-label">Token:</label>
                            <input type="text" class="form-control" id="thirdPartyToken" name="thirdPartyToken"
                                   required/>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Store Third Party Token</button>
                        </div>
                    </form>
                </div>
            </div>

            @* <!-- Create New Token Section -->
            <div class="card shadow-sm mt-5">
                <div class="card-header text-bg-secondary">
                    <h3>Create New API Token</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div class="form-group mb-3">
                            <label for="name">Token Name:</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <button type="submit" class="btn btn-success">Create Token</button>
                    </form>
                </div>
            </div> *@
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-10 offset-1">
            <div class="card shadow-sm mt-5">
                <div class="card-header text-bg-secondary">
                    <h3>Mobile API JSON Examples</h3>
                </div>
                <div class="card-body">
                    <p class="mb-3">Use the following JSON bodies with your <code>Authorization: Bearer
                            &lt;token&gt;</code> header against the API endpoints.</p>

                    <h5 class="mt-3">1) Log Location</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "latitude": 37.9838,
                        "longitude": 23.7275,
                        "accuracy": 12.5,
                        "altitude": 95.0,
                        "speed": 1.2,
                        "locationType": "GPS",
                        "notes": "Walking in the center",
                        "activityTypeId": 3,
                        "timestamp": "2025-07-30T09:15:00" // local device time
                        }
                    </code>
                    <small class="text-muted">POST @serverBaseUrl/api/location/log-location</small>

                    <h5 class="mt-4">2) Check-in</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "latitude": 37.9838,
                        "longitude": 23.7275,
                        "accuracy": 10,
                        "locationType": "Manual",
                        "notes": "Arrived",
                        "timestamp": "2025-07-30T09:20:00"
                        }
                    </code>
                    <small class="text-muted">POST @serverBaseUrl/api/location/check-in</small>

                    <h5 class="mt-4">3) Update Location (partial)</h5>
                    <p class="mb-1">Only included fields change. Use clear flags to remove notes/activity.</p>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "latitude": 37.9755,
                        "longitude": 23.7348,
                        "localTimestamp": "2025-07-30T09:45:00",
                        "notes": "At venue entrance",
                        "activityTypeId": 5,
                        "activityName": "Running",
                        "clearNotes": false,
                        "clearActivity": false
                        }
                    </code>
                    <small class="text-muted">PUT @serverBaseUrl/api/location/{id}</small>

                    <h6 class="mt-2">Clear examples</h6>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        { "clearNotes": true }
                    </code>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        { "clearActivity": true }
                    </code>

                    <h5 class="mt-4">4) Delete Location</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        // No body required
                    </code>
                    <small class="text-muted">DELETE @serverBaseUrl/api/location/{id}</small>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-10 offset-1">
            <div class="card shadow-sm mt-5">
                <div class="card-header text-bg-secondary">
                    <h3>Trip API JSON Examples</h3>
                </div>
                <div class="card-body">
                    <p class="mb-3">Examples for creating, updating, and deleting regions and places. Include <code>Authorization:
                            Bearer &lt;token&gt;</code>.</p>

                    <h5 class="mt-3">1) Create Region</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "name": "Athens",
                        "notes": "City center",
                        "coverImageUrl": "https://example.com/cover.jpg",
                        "centerLatitude": 37.9838,
                        "centerLongitude": 23.7275
                        }
                    </code>
                    <small class="text-muted">POST @serverBaseUrl/api/trips/{tripId}/regions</small>

                    <h5 class="mt-4">2) Update Region</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "name": "Athens Downtown",
                        "displayOrder": 2
                        }
                    </code>
                    <small class="text-muted">PUT @serverBaseUrl/api/trips/regions/{regionId}</small>

                    <h5 class="mt-4">3) Delete Region</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        // No body required
                    </code>
                    <small class="text-muted">DELETE @serverBaseUrl/api/trips/regions/{regionId}</small>

                    <h5 class="mt-4">4) Create Place</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "regionId": "{regionId}",
                        "name": "Acropolis Museum",
                        "latitude": 37.9680,
                        "longitude": 23.7286,
                        "notes": "Must visit",
                        "iconName": "marker",
                        "markerColor": "bg-blue"
                        }
                    </code>
                    <small class="text-muted">POST @serverBaseUrl/api/trips/{tripId}/places</small>

                    <h5 class="mt-4">5) Update Place</h5>
                    <p class="mb-1">Icon name defaults to "marker" and color to "bg-blue" when cleared.</p>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        {
                        "name": "Acropolis Museum Entrance",
                        "clearIcon": true,
                        "clearMarkerColor": true
                        }
                    </code>
                    <small class="text-muted">PUT @serverBaseUrl/api/trips/places/{placeId}</small>

                    <h5 class="mt-4">6) Delete Place</h5>
                    <code class="d-block p-3 bg-body-tertiary border rounded" style="white-space: pre; display:block;">
                        // No body required
                    </code>
                    <small class="text-muted">DELETE @serverBaseUrl/api/trips/places/{placeId}</small>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- JavaScript for QR Code Generation and Token Regeneration -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        @if (Model.Tokens != null && Model.Tokens.Any())
        {
            var token = Model.Tokens.FirstOrDefault(t => t.Name.Equals("Wayfarer Incoming Location Data API Token"));
            if (token != null)
            {
                // Output JavaScript variables from Razor
                @:var newTokenFromTempData = "@Html.Raw(newToken ?? "")";
                @:var newTokenNameFromTempData = "@Html.Raw(newTokenName ?? "")";
                @:var isHashedToken = @(token.IsHashedToken ? "true" : "false");
                @:var plainToken = "@Html.Raw(token.Token ?? "")";
                @:var serverBaseUrl = "@serverBaseUrl";
                @:var userName = "@Model.UserName";
                @:var serverName = "@Context.Request.Host.Host";

                <text>
                    // Determine which token to use for QR code
                    var tokenForQr = '';

                    if (newTokenFromTempData && newTokenNameFromTempData === 'Wayfarer Incoming Location Data API Token') {
                        // Use the new token from TempData (just created/regenerated)
                        tokenForQr = newTokenFromTempData;
                    } else if (!isHashedToken && plainToken) {
                        // Use the plain token (legacy unhashed token)
                        tokenForQr = plainToken;
                    }

                    if (tokenForQr) {
                        // Generate single Mobile Configuration QR Code with automatic URL detection
                        try {
                            var mobileConfig = {
                                serverUrl: serverBaseUrl,
                                apiToken: tokenForQr,
                                userName: userName,
                                serverName: serverName,
                                version: '1.0'
                            };

                            // Debug logging for QR generation
                            console.log('üîç Auto-detected server URL for QR code:', serverBaseUrl);
                            console.log('üì± Generating QR code with config:', mobileConfig);

                            new QRCode(document.getElementById('qr-mobile-config'), {
                                text: JSON.stringify(mobileConfig),
                                width: 150,
                                height: 150,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.M
                            });

                            console.log('‚úÖ QR code generated successfully');
                        } catch (error) {
                            document.getElementById('qr-mobile-config').innerHTML = '<div class="text-danger small">‚ùå Error generating QR code</div>';
                            console.error('‚ùå Error generating mobile configuration QR code:', error);
                        }
                    } else {
                        // Token is hashed and no new token available - show regenerate prompt
                        document.getElementById('qr-mobile-config').innerHTML =
                            '<div class="alert alert-info text-center py-4">' +
                            '<i class="bi bi-shield-lock fs-1 d-block mb-2"></i>' +
                            '<p class="mb-2"><strong>Token is securely stored</strong></p>' +
                            '<p class="small mb-3">For security, your token is hashed and cannot be displayed. Click "Regenerate" below to create a new token and QR code.</p>' +
                            '</div>';
                    }
                </text>
            }
        }
    });

    /**
     * Regenerates the Wayfarer API token with user confirmation
     */
    function regenerateWayfarerToken() {
        // Show confirmation modal with HTML formatted message
        const modal = document.getElementById('deleteConfirmationModal');
        if (!modal) {
            console.error('Confirmation modal not found');
            return;
        }

        const modalInstance = new bootstrap.Modal(modal);
        const modalTitle = modal.querySelector('.modal-title');
        const modalBody = modal.querySelector('.modal-body');
        const confirmButton = modal.querySelector('.btn-danger');

        modalTitle.textContent = 'Regenerate API Token?';
        modalBody.innerHTML = `
            <p><strong>This action will regenerate your Wayfarer API token.</strong></p>
            <p>After regeneration, you will need to update the new token in:</p>
            <ul>
                <li>Wayfarer Mobile App</li>
                <li>GPS Logger or other third-party apps</li>
                <li>Any custom integrations</li>
            </ul>
            <p class="text-danger"><strong>Your current token will immediately stop working.</strong></p>
            <p>Do you want to continue?</p>
        `;
        confirmButton.textContent = 'Yes, Regenerate Token';

        confirmButton.onclick = async function() {
            try {
                // Call regenerate endpoint with token name in URL
                const response = await fetch('@Url.Action("Regenerate", "ApiToken", new { area = "User" })?name=' + encodeURIComponent('Wayfarer Incoming Location Data API Token'), {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Update token display
                    const tokenElement = document.getElementById('wayfarer-token');
                    if (tokenElement) {
                        tokenElement.textContent = result.token;
                    }

                    // Regenerate QR code with new token
                    const qrContainer = document.getElementById('qr-mobile-config');
                    if (qrContainer) {
                        qrContainer.innerHTML = ''; // Clear old QR code
                        const mobileConfig = {
                            serverUrl: '@serverBaseUrl',
                            apiToken: result.token,
                            userName: '@Model.UserName',
                            serverName: '@Context.Request.Host.Host',
                            version: '1.0'
                        };

                        new QRCode(qrContainer, {
                            text: JSON.stringify(mobileConfig),
                            width: 150,
                            height: 150,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    }

                    // Close modal
                    modalInstance.hide();

                    // Show success toast
                    wayfarer.showToast('success', result.message, 5000);
                } else {
                    wayfarer.showToast('danger', 'Failed to regenerate token. Please try again.', 5000);
                }
            } catch (error) {
                console.error('Error regenerating token:', error);
                wayfarer.showToast('danger', 'An error occurred while regenerating the token.', 5000);
            }
        };

        // Show modal
        modalInstance.show();
    }
</script>

@* 
ZERO CONFIGURATION FEATURES:

‚úÖ localhost:5000 ‚Üí http://localhost:5000
‚úÖ 192.168.1.100:5000 ‚Üí http://192.168.1.100:5000  
‚úÖ wayfarer.example.com ‚Üí https://wayfarer.example.com
‚úÖ wayfarer.stefk.me ‚Üí https://wayfarer.stefk.me (your case)
‚úÖ Behind nginx with X-Forwarded-Proto ‚Üí https://domain.com
‚úÖ Production environment ‚Üí https://domain.com
‚úÖ Docker containers ‚Üí http://container-ip:port

Self-hosters don't need to configure anything!
The system automatically detects the correct protocol for QR codes.
*@

