@model IEnumerable<Wayfarer.Models.LocationImport>
@{
    ViewData["BodyClass"] = "container-fluid";
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@ViewData["Title"]</h2>
    <a asp-controller="LocationImport" asp-action="Upload" class="btn btn-primary">
        <i class="bi bi-upload"></i> Upload New File
    </a>
</div>

<table class="table table-striped table-responsive" id="locationImport" data-user-id="@ViewData["UserId"]">
    <thead>
        <tr>
            <th>File Name</th>
            <th>Uploaded At</th>
            <th>Status</th>
            <th>Processed Records</th>
            <th>Last Processed Record</th>
            <th>Errors</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var import in Model)
    {
        <tr>
            <td class="filePath">@System.IO.Path.GetFileName(import.FilePath)</td>
            <td>@import.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
            <td class="importStatus">
                @if (import.Status == ImportStatus.Stopped)
                {
                    <span class="badge bg-dark">@import.Status</span>
                }
                else if (import.Status == ImportStatus.Completed)
                {
                    <span class="badge bg-success">@import.Status</span>
                }
                else if (import.Status == ImportStatus.Failed)
                {
                    <span class="badge bg-danger">@import.Status</span>
                }
                else if (import.Status == ImportStatus.InProgress)
                {
                    <span class="badge bg-info">@import.Status</span>
                }
                else if (import.Status == ImportStatus.Stopping)
                {
                    <span class="badge bg-secondary">@import.Status</span>
                }
            </td>
            <td class="text-center lastProcessedIndex" data-total-records="@import.TotalRecords">
                @import.LastProcessedIndex of @import.TotalRecords
            </td>
            <td class="text-center lastImportedRecord">
                @import.LastImportedRecord
            </td>
            <td class="text-center errorMessage">
                @import.ErrorMessage
            </td>
            <td>
                @{
                    // decide which primary button to show
                    bool showDropdown = false;
                    string? primaryLabel = null, primaryAction = null;

                    if (import.Status == ImportStatus.Stopped || import.Status == ImportStatus.Failed)
                    {
                        primaryLabel  = "Start";
                        primaryAction = "start";
                        showDropdown  = true;
                    }
                    else if (import.Status == ImportStatus.InProgress)
                    {
                        primaryLabel  = "Stop";
                        primaryAction = "stop";
                        showDropdown  = true;
                    }
                    else if (import.Status == ImportStatus.Stopping)
                    {
                        primaryLabel = "Stoppingâ€¦";
                        // disabled, no action
                    }
                    else if (import.Status == ImportStatus.Completed)
                    {
                        // no primary, but allow delete
                        showDropdown = true;
                    }
                }

                <div class="btn-group">
                    @* Primary action button *@
                    @if (primaryLabel != null)
                    {
                        <button
                            type="button"
                            class="btn btn-sm btn-primary js-import-action"
                            data-action="@primaryAction"
                            data-id="@import.Id"
                            @(primaryAction == null ? "disabled" : "")>
                            @primaryLabel
                        </button>
                    }

                    @* Dropdown for Delete/Cancel *@
                    @if (showDropdown)
                    {
                        <button type="button"
                                class="btn btn-sm btn-primary dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="#"
                                   class="dropdown-item text-danger js-delete-import"
                                   data-id="@import.Id"
                                   data-status="@import.Status">
                                    Delete
                                </a>
                            </li>
                        </ul>
                    }
                </div>
            </td>
        </tr>
    }
    </tbody>
</table>

@if (!Model.Any())
{
    <div class="alert alert-info">No location import records found.</div>
}

@* Hidden antiforgery token *@
<div style="display:none;">
    @Html.AntiForgeryToken()
</div>

@* Pre-generate all URLs into a JS config object *@
<script>
    window.__locationImportConfig = {
        deleteUrl      : '@Url.Action("Delete",      "LocationImport")',
        startImportUrl : '@Url.Action("StartImport", "LocationImport")',
        stopImportUrl  : '@Url.Action("StopImport",  "LocationImport")'
    };
    const locationImport = document.getElementById('locationImport');
    const userId = locationImport.dataset.userId;
</script>

@section Scripts {
    @Html.FrontendViewScripts()
}
