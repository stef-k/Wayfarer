@{
    ViewData["Title"] = "My Groups";
    ViewData["BodyClass"] = "container";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@ViewData["Title"]</h2>
    <a class="btn btn-primary" asp-area="User" asp-controller="Groups" asp-action="Create">New Group</a>
</div>

<table class="table table-striped">
    <thead>
    <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Type</th>
        <th>Members</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="groupsBody">
    @{
        // Server-provided fallback rendering; JS will enhance/handle actions.
        var joined = ViewBag.Joined as IEnumerable<dynamic>;
        if (joined != null)
        {
            foreach (var g in joined)
            {
                <tr data-group-id="@g.Id">
                    <td>@g.Name</td>
                    <td>@g.Description</td>
                    <td>@g.GroupType</td>
                    <td>
                        @{
                            var counts = ViewBag.MemberCounts as IDictionary<Guid,int>;
                            var gid = (Guid)g.Id;
                            var cnt = counts != null && counts.ContainsKey(gid) ? counts[gid] : 0;
                        }
                        <span class="badge bg-secondary js-member-count" data-group-id="@g.Id">@cnt</span>
                    </td>
                    <td class="text-nowrap">
                        <a class="btn btn-sm btn-primary" asp-area="User" asp-controller="Groups" asp-action="Map" asp-route-groupId="@g.Id">Map</a>
                        @if (string.Equals((string)g.GroupType, "Family", StringComparison.OrdinalIgnoreCase) || string.Equals((string)g.GroupType, "Friends", StringComparison.OrdinalIgnoreCase))
                        {
                            <a class="btn btn-sm btn-info" asp-area="User" asp-controller="Groups" asp-action="Members" asp-route-groupId="@g.Id">Members</a>
                        }
                        <button type="button" class="btn btn-sm btn-outline-danger js-leave" data-group-id="@g.Id">Leave</button>
                    </td>
                </tr>
            }
        }
    }
    </tbody>
</table>

<script type="module" src="~/js/Areas/User/Groups/index.js"></script>

