@model ApplicationSettings
@{
    var isRegistrationOpen = (ViewData["IsRegistrationOpen"] as bool?) ?? false;
}

<div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                <div class="card-header text-bg-primary">
                    <h2 class="mb-0 text-center">@ViewData["Title"]</h2>
                </div>
                <div class="card-body">
                    <h3 class="text-center fs-4">Location Logging</h3>
                    <p>These settings control how often mobile devices send location pings and how much data is recorded.
                        The app ignores incoming requests that may be too frequent or
                        do not meet the minimum distance change from the previous recorded location.</p>

                    <div class="alert alert-warning">
                        <strong><i class="bi bi-battery-half me-1"></i>Mobile Battery Impact:</strong>
                        Lower time thresholds require more frequent GPS wake-ups, increasing battery drain.
                        Mobile devices wake ~60s before each ping for GPS acquisition.
                        <ul class="mb-0 mt-2">
                            <li><code>2 min</code>: <strong class="text-danger">High battery drain</strong> – continuous GPS, no sleep possible</li>
                            <li><code>3 min</code>: High – ~2 min sleep, ~1 min active per cycle</li>
                            <li><code>5 min</code>: Moderate – ~4 min sleep, ~1 min active per cycle (recommended)</li>
                            <li><code>10 min</code>: Good – ~9 min sleep, ~1 min active per cycle</li>
                            <li><code>15 min</code>: <strong>Best battery life</strong> – ~14 min sleep, ~1 min active per cycle</li>
                        </ul>
                    </div>

                    <p>
                        <strong>Database storage (worst-case yearly per user):</strong><br/>
                        <code>2</code> minutes: <code class="text-danger">262,800</code> records/year<br/>
                        <code>3</code> minutes: <code>175,200</code> records/year<br/>
                        <code>5</code> minutes: <code>105,120</code> records/year (recommended)<br/>
                        <code>10</code> minutes: <code>52,560</code> records/year<br/>
                        <code>15</code> minutes: <code>35,040</code> records/year
                    </p>
                    <form asp-action="Update" method="post">
                        @Html.AntiForgeryToken()

                        <div class="row">

                            <div class="col-md-6">
                                <label for="LocationTimeThresholdMinutes" class="form-label">Time Threshold (in
                                    minutes):</label>
                                <select asp-for="LocationTimeThresholdMinutes" class="form-control" id="timeThresholdSelect">
                                    <option value="2" class="text-danger fw-bold">2 ⚠️ (High resource usage)</option>
                                    <option value="3">3</option>
                                    <option value="5">5 (Recommended)</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                </select>
                                <small id="timeThresholdWarning" class="form-text text-danger d-none">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                    <strong>Warning:</strong> 2-minute threshold provides highest location detail but significantly
                                    increases database storage and drains mobile device battery (continuous GPS, no sleep possible).
                                </small>
                                <span asp-validation-for="LocationTimeThresholdMinutes" class="text-danger"></span>
                            </div>


                            <div class="col-md-6">
                                <label for="LocationDistanceThresholdMeters" class="form-label">Distance Threshold (in
                                    meters):</label>
                                <select asp-for="LocationDistanceThresholdMeters" class="form-control">
                                    <optgroup label="Fine (5-50m)">
                                        <option value="5">5 m</option>
                                        <option value="10">10 m</option>
                                        <option value="15">15 m (Default)</option>
                                        <option value="20">20 m</option>
                                        <option value="25">25 m</option>
                                        <option value="30">30 m</option>
                                        <option value="35">35 m</option>
                                        <option value="40">40 m</option>
                                        <option value="45">45 m</option>
                                        <option value="50">50 m</option>
                                    </optgroup>
                                    <optgroup label="Medium (55-150m)">
                                        <option value="55">55 m</option>
                                        <option value="60">60 m</option>
                                        <option value="65">65 m</option>
                                        <option value="70">70 m</option>
                                        <option value="75">75 m</option>
                                        <option value="80">80 m</option>
                                        <option value="85">85 m</option>
                                        <option value="90">90 m</option>
                                        <option value="95">95 m</option>
                                        <option value="100">100 m</option>
                                        <option value="105">105 m</option>
                                        <option value="110">110 m</option>
                                        <option value="115">115 m</option>
                                        <option value="120">120 m</option>
                                        <option value="125">125 m</option>
                                        <option value="130">130 m</option>
                                        <option value="135">135 m</option>
                                        <option value="140">140 m</option>
                                        <option value="145">145 m</option>
                                        <option value="150">150 m</option>
                                    </optgroup>
                                    <optgroup label="Coarse (200m-1km)">
                                        <option value="200">200 m</option>
                                        <option value="250">250 m</option>
                                        <option value="300">300 m</option>
                                        <option value="350">350 m</option>
                                        <option value="400">400 m</option>
                                        <option value="450">450 m</option>
                                        <option value="500">500 m</option>
                                        <option value="550">550 m</option>
                                        <option value="600">600 m</option>
                                        <option value="650">650 m</option>
                                        <option value="700">700 m</option>
                                        <option value="750">750 m</option>
                                        <option value="800">800 m</option>
                                        <option value="850">850 m</option>
                                        <option value="900">900 m</option>
                                        <option value="950">950 m</option>
                                        <option value="1000">1 km</option>
                                    </optgroup>
                                    <optgroup label="Very Coarse (1.5-5km)">
                                        <option value="1500">1.5 km</option>
                                        <option value="2000">2 km</option>
                                        <option value="2500">2.5 km</option>
                                        <option value="3000">3 km</option>
                                        <option value="3500">3.5 km</option>
                                        <option value="4000">4 km</option>
                                        <option value="4500">4.5 km</option>
                                        <option value="5000">5 km</option>
                                    </optgroup>
                                    <optgroup label="Regional (10-50km)">
                                        <option value="10000">10 km</option>
                                        <option value="15000">15 km</option>
                                        <option value="20000">20 km</option>
                                        <option value="25000">25 km</option>
                                        <option value="30000">30 km</option>
                                        <option value="35000">35 km</option>
                                        <option value="40000">40 km</option>
                                        <option value="45000">45 km</option>
                                        <option value="50000">50 km</option>
                                    </optgroup>
                                    <optgroup label="Maximum (100km)">
                                        <option value="100000">100 km</option>
                                    </optgroup>
                                </select>
                                <span asp-validation-for="LocationDistanceThresholdMeters" class="text-danger"></span>
                            </div>

                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">Trip Place Auto-Visited</h3>
                            <p class="text-muted">
                                Automatically detect when users visit planned trip places based on location pings.
                                Time-based settings (hit window, stale cleanup, visit end timeout) are derived from
                                the Location Time Threshold above.
                            </p>

                            <div class="alert alert-info">
                                <strong><i class="bi bi-clock-history me-1"></i>Visit Confirmation Timing:</strong>
                                A visit is confirmed when the required number of pings arrive within the time threshold,
                                spanning at least the threshold duration.<br/>
                                <strong>Formula:</strong> <code>Time Threshold × Required Hits = Minimum Confirmation Time</code><br/>
                                <ul class="mb-0 mt-2">
                                    <li>2 min threshold × 2 hits = <strong>4 min</strong> minimum to confirm visit</li>
                                    <li>3 min threshold × 2 hits = <strong>6 min</strong> minimum to confirm visit</li>
                                    <li>5 min threshold × 2 hits = <strong>10 min</strong> minimum to confirm visit</li>
                                    <li>10 min threshold × 2 hits = <strong>20 min</strong> minimum to confirm visit</li>
                                    <li>15 min threshold × 2 hits = <strong>30 min</strong> minimum to confirm visit</li>
                                </ul>
                                <small class="text-muted d-block mt-2">
                                    <i class="bi bi-info-circle me-1"></i>Lower thresholds detect visits faster but drain more battery.
                                    Higher hit counts increase accuracy but require longer dwell times.
                                </small>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="VisitedRequiredHits" class="form-label">Required Hits</label>
                                <input asp-for="VisitedRequiredHits" class="form-control" type="number" min="2" max="5" />
                                <small class="form-text text-muted">
                                    Number of pings needed to confirm a visit (2-5).<br/>
                                    <em>Current: @Model.LocationTimeThresholdMinutes min × @Model.VisitedRequiredHits hits = @(Model.LocationTimeThresholdMinutes * Model.VisitedRequiredHits) min confirmation</em>
                                </small>
                                <span asp-validation-for="VisitedRequiredHits" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="VisitedMinRadiusMeters" class="form-label">Min Radius (meters)</label>
                                <input asp-for="VisitedMinRadiusMeters" class="form-control" type="number" min="10" max="200" />
                                <small class="form-text text-muted">
                                    Minimum detection radius for good GPS (10-200).<br/>
                                    <em>Smaller = more precise, but may miss visits with GPS drift.</em>
                                </small>
                                <span asp-validation-for="VisitedMinRadiusMeters" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="VisitedMaxRadiusMeters" class="form-label">Max Radius (meters)</label>
                                <input asp-for="VisitedMaxRadiusMeters" class="form-control" type="number" min="50" max="500" />
                                <small class="form-text text-muted">
                                    Maximum radius ceiling for poor GPS (50-500).<br/>
                                    <em>Larger = more forgiving, but increases false positives.</em>
                                </small>
                                <span asp-validation-for="VisitedMaxRadiusMeters" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="VisitedAccuracyMultiplier" class="form-label">Accuracy Multiplier</label>
                                <input asp-for="VisitedAccuracyMultiplier" class="form-control" type="number" step="0.1" min="0.5" max="5.0" />
                                <small class="form-text text-muted">
                                    Multiplier applied to GPS accuracy (0.5-5.0).<br/>
                                    <em>Lower = stricter matching, higher = more lenient.</em>
                                </small>
                                <span asp-validation-for="VisitedAccuracyMultiplier" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="VisitedAccuracyRejectMeters" class="form-label">Accuracy Reject (meters)</label>
                                <input asp-for="VisitedAccuracyRejectMeters" class="form-control" type="number" min="0" max="1000" />
                                <small class="form-text text-muted">
                                    Skip pings with accuracy worse than this (0 = disabled).<br/>
                                    <em>Filters out unreliable indoor/urban canyon readings.</em>
                                </small>
                                <span asp-validation-for="VisitedAccuracyRejectMeters" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="VisitedMaxSearchRadiusMeters" class="form-label">Search Radius (meters)</label>
                                <input asp-for="VisitedMaxSearchRadiusMeters" class="form-control" type="number" min="50" max="2000" />
                                <small class="form-text text-muted">Database query radius for nearby places (50-2000)</small>
                                <span asp-validation-for="VisitedMaxSearchRadiusMeters" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="VisitedPlaceNotesSnapshotMaxHtmlChars" class="form-label">Notes Max Characters</label>
                                <input asp-for="VisitedPlaceNotesSnapshotMaxHtmlChars" class="form-control" type="number" min="1000" max="200000" />
                                <small class="form-text text-muted">Maximum HTML characters for notes snapshot (1000-200000)</small>
                                <span asp-validation-for="VisitedPlaceNotesSnapshotMaxHtmlChars" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="alert alert-info mb-0">
                                    <strong>Derived from Time Threshold (@Model.LocationTimeThresholdMinutes min):</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Hit Window: <code>@Model.LocationTimeThresholdMinutes × 1.6 = @Model.VisitedHitWindowMinutes min</code>
                                            <br/><small class="text-muted">Max time between pings to count as consecutive hits</small></li>
                                        <li>Candidate Stale: <code>@Model.LocationTimeThresholdMinutes × 12 = @Model.VisitedCandidateStaleMinutes min</code>
                                            <br/><small class="text-muted">Cleanup incomplete visit candidates after this</small></li>
                                        <li>End Visit After: <code>@Model.LocationTimeThresholdMinutes × 9 = @Model.VisitedEndVisitAfterMinutes min</code>
                                            <br/><small class="text-muted">Close active visit after no pings for this duration</small></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">New User Registrations</h3>
                            <div class="col-md-12 mb-2">
                                <div class="form-group">
                                    <label for="IsRegistrationOpen" class="form-label">Allow New User
                                        Registrations?</label>

                                    <!-- Use Bootstrap's built-in large checkbox class -->
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input form-check-input-lg"
                                               id="IsRegistrationOpen" name="IsRegistrationOpen"
                                               value="true" @(Model.IsRegistrationOpen ? "checked" : "")/>
                                        <label class="form-check-label" for="IsRegistrationOpen">Enable new user
                                            registrations</label>
                                    </div>

                                    <small class="form-text text-muted">Check to allow new user registrations.</small>
                                </div>
                            </div>
                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">User Uploads</h3>
                            <div class="col-md-8">
                                <div class="col-12 mb-2">
                                    <strong>Uploads Directory Path: </strong><code>@ViewData["UploadsPath"]</code>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-4">
                                        <strong>Upload File Count:</strong><br/>
                                        <code>@ViewData["UploadsFileCount"]</code>
                                    </div>
                                    <div class="col-4">
                                        <strong>Total Upload Size:</strong><br/>
                                        <code>@ViewData["UploadsSizeMB"] MB</code>
                                    </div>
                                    <div class="col-4">
                                        <strong>Total Upload Size:</strong><br/>
                                        <code>@ViewData["UploadsSizeGB"] GB</code>
                                    </div>
                                </div>

                                <label for="UploadSizeLimitMB" class="form-label">
                                    Maximum Upload Size (currently: <code>@Model.UploadSizeLimitMB</code> MB):
                                </label>

                                <div class="input-group">
                                    <input asp-for="UploadSizeLimitMB"
                                           class="form-control"
                                           type="number"
                                           step="0.1"
                                           min="-1"/>
                                    <span class="input-group-text">MB</span>
                                </div>

                                <span asp-validation-for="UploadSizeLimitMB" class="text-danger"></span>
                            </div>

                            <div class="form-text">
                                • Used to allow users to upload location data files, such as exported Google Timeline
                                JSON data.<br/>
                                • Set to <code>-1</code> to disable uploads entirely.<br/>
                                • Set to <code>0</code> to use the default:
                                <code>@ApplicationSettings.DefaultUploadSizeLimitMB MB</code>.<br/>
                            </div>
                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">Map Tile Cache Management</h3>
                            <div class="col-12 mb-2">
                                <strong>Cache Directory Path: </strong><code>@ViewData["CachePath"]</code>
                            </div>
                            <hr/>
                            <div class="col-5 mb-2">
                                <strong>Total Cache Files: </strong><code
                                    id="TotalCacheFiles">@ViewData["TotalCacheFiles"]</code>
                            </div>
                            <div class="col-7 mb-2">
                                <strong>Total LRU (Least Recently Used) Cache Files for zoom levels >= 9: </strong><code
                                    id="LruTotalFiles">@ViewData["LruTotalFiles"]</code>
                            </div>
                            <hr/>
                            <div class="col-5 mb-2">
                                <strong>Total Cache Size in Megabytes: </strong><code
                                    id="TotalCacheSize">@ViewData["TotalCacheSize"] MB</code>
                            </div>
                            <div class="col-7 mb-2">
                                <strong>Total LRU Size (zoom levels >= 9) in Megabytes: </strong><code
                                    id="TotalLru">@ViewData["TotalLru"] MB</code>
                            </div>

                            <hr/>
                            <div class="col-5 mb-2">
                                <strong>Total Cache Size in Gigabytes: </strong><code
                                    id="TotalCacheSizeGB">@ViewData["TotalCacheSizeGB"] GB</code>
                            </div>

                            <div class="col-7 mb-2">
                                <strong>Total LRU Size (zoom levels >= 9) in Gigabytes: </strong><code
                                    id="TotalLruGB">@ViewData["TotalLruGB"] GB</code>
                            </div>
                            <hr/>
                            <div class="col-md-8">
                                <label for="MaxCacheTileSizeInMB" class="form-label">
                                    Maximum Size for Tile Cache in Megabytes:
                                </label>

                                <div class="input-group">
                                    <input asp-for="MaxCacheTileSizeInMB"
                                           class="form-control"
                                           type="number"
                                           step="0.01"
                                           min="-1"/>
                                    <span class="input-group-text">MB</span>
                                </div>

                                <span asp-validation-for="MaxCacheTileSizeInMB" class="text-danger"></span>

                                <div class="form-text">
                                    • This setting controls the maximum cache size (in MB) for map tiles at zoom levels
                                    ≥ 9.<br/>
                                    • Set to <code>-1</code> to disable this cache entirely.<br/>
                                    • Set to <code>0</code> to fallback to the default:
                                    <code>@ApplicationSettings.DefaultMaxCacheTileSizeInMB MB</code>.<br/>
                                    • Tiles are ~10–20 KB each. The default (1024 MB) holds roughly 100,000–200,000
                                    tiles.<br/>
                                    • Zoom levels 0–8 are cached permanently and do not count against this size. They
                                    consume ~1.31 to 1.75 GB.<br/>
                                    • Increasing this value reduces OSM server usage. If exceeded, least-recently-used
                                    tiles are purged.<br/>
                                </div>
                            </div>


                            <div class="col-md-4">
                                <div class="row mt-3">
                                    <div class="col">
                                        <a href="#" class="btn btn-danger" id="clearLruCache"
                                           title="Clear LRU Map Cache">Clear LRU Cache (zoom levels >= 9)</a>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col"><a href="#" class="btn btn-danger" id="clearAllCache"
                                                        title="Clear All Map Cache">Clear All Map Tile Cache!</a></div>
                                </div>
                            </div>

                        </div>

                        <hr/>
                        
                        <div class="row">
                            <h3 class="text-center fs-2">Total Disk Usage</h3>

                            <div class="col-4 mb-2 fs-5">
                                <strong>Map Tiles Cache (zoom ≥ 9):</strong><br/>
                                <code>@ViewData["TotalCacheSize"] MB</code> /
                                <code>@ViewData["TotalCacheSizeGB"] GB</code>
                            </div>

                            <div class="col-4 mb-2 fs-5">
                                <strong>User Uploads (Temp):</strong><br/>
                                <code>@ViewData["UploadsSizeMB"] MB</code> / <code>@ViewData["UploadsSizeGB"] GB</code>
                            </div>
                        </div>

                        <!-- Separate row for combined total -->
                        <div class="row mt-3">
                            <div class="col-6 fs-5">
                                <strong>Total Storage Used in Megabytes:</strong>
                                <code class="text-primary">@ViewData["CombinedStorageMB"] MB</code>
                            </div>
                            <div class="col-6 fs-5">
                                <strong>Total Storage Used in Gigabytes:</strong>
                                <code class="text-primary">@ViewData["CombinedStorageGB"] GB</code>
                            </div>
                        </div>

                        <div class="form-text fs-6 mt-2">
                            • This includes storage used by: map tile cache (zoom ≥ 9),PBF used for mobile routing and routing files, and
                            uploaded files (e.g. Google Timeline JSON).<br/>
                            • Zoom levels 0–8 are permanent and not included in soft limits.<br/>
                            • Use this summary to estimate how much disk Wayfarer currently occupies on your server.
                        </div>


                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg mt-3">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            @if (TempData["Message"] != null)
            {
                <div class="alert alert-success mt-3">
                    @TempData["Message"]
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    @Html.FrontendViewScripts()
}
