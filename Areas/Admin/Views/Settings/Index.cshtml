@model ApplicationSettings
@{
    var isRegistrationOpen = (ViewData["IsRegistrationOpen"] as bool?) ?? false;
}

<div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                <div class="card-header text-bg-primary">
                    <h2 class="mb-0 text-center">@ViewData["Title"]</h2>
                </div>
                <div class="card-body">
                    <h3 class="text-center fs-4">Location Logging</h3>
                    <p>These settings used to handle how much data will be recorded on database.
                        The app ignores incoming requests that may be too frequent or
                        do not meet the minimum instance change from the previous recorded location. <br/>
                        <strong>Caution! setting the threshold level too low will result to increased records in
                            database stored.</strong><br/>
                        At 5 minutes/15 meters threshold (application default), about 105,120 locations will be recorded
                        yearly per user,
                        based in a worst case scenario that a user is always moving (24/7) meeting the distance
                        threshold.<br/>
                        Possible other worst case scenario values:<br/>
                        <code>2</code> minutes: <code>262,800</code> records per user per year<br/>
                        <code>5</code> minutes: <code>105,120</code> records per user per year<br/>
                        <code>10</code> minutes: <code>52,560</code> records per user per year<br/>
                        <code>15</code> minutes: <code>35,040</code> records per user per year<br/>
                    </p>
                    <form asp-action="Update" method="post">
                        @Html.AntiForgeryToken()

                        <div class="row">

                            <div class="col-md-6">
                                <label for="LocationTimeThresholdMinutes" class="form-label">Time Threshold (in
                                    minutes):</label>
                                <select asp-for="LocationTimeThresholdMinutes" class="form-control">
                                    <option value="2">2</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                </select>
                                <span asp-validation-for="LocationTimeThresholdMinutes" class="text-danger"></span>
                            </div>


                            <div class="col-md-6">
                                <label for="LocationDistanceThresholdMeters" class="form-label">Distance Threshold (in
                                    meters):</label>
                                <select asp-for="LocationDistanceThresholdMeters" class="form-control">
                                    <option value="5">5</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="50">50</option>
                                </select>
                                <span asp-validation-for="LocationDistanceThresholdMeters" class="text-danger"></span>
                            </div>

                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">New User Registrations</h3>
                            <div class="col-md-12 mb-2">
                                <div class="form-group">
                                    <label for="IsRegistrationOpen" class="form-label">Allow New User
                                        Registrations?</label>

                                    <!-- Use Bootstrap's built-in large checkbox class -->
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input form-check-input-lg"
                                               id="IsRegistrationOpen" name="IsRegistrationOpen"
                                               value="true" @(Model.IsRegistrationOpen ? "checked" : "")/>
                                        <label class="form-check-label" for="IsRegistrationOpen">Enable new user
                                            registrations</label>
                                    </div>

                                    <small class="form-text text-muted">Check to allow new user registrations.</small>
                                </div>
                            </div>
                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">User Uploads</h3>
                            <div class="col-md-8">
                                <div class="col-12 mb-2">
                                    <strong>Uploads Directory Path: </strong><code>@ViewData["UploadsPath"]</code>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-4">
                                        <strong>Upload File Count:</strong><br/>
                                        <code>@ViewData["UploadsFileCount"]</code>
                                    </div>
                                    <div class="col-4">
                                        <strong>Total Upload Size:</strong><br/>
                                        <code>@ViewData["UploadsSizeMB"] MB</code>
                                    </div>
                                    <div class="col-4">
                                        <strong>Total Upload Size:</strong><br/>
                                        <code>@ViewData["UploadsSizeGB"] GB</code>
                                    </div>
                                </div>

                                <label for="UploadSizeLimitMB" class="form-label">
                                    Maximum Upload Size (currently: <code>@Model.UploadSizeLimitMB</code> MB):
                                </label>

                                <div class="input-group">
                                    <input asp-for="UploadSizeLimitMB"
                                           class="form-control"
                                           type="number"
                                           step="0.1"
                                           min="-1"/>
                                    <span class="input-group-text">MB</span>
                                </div>

                                <span asp-validation-for="UploadSizeLimitMB" class="text-danger"></span>
                            </div>

                            <div class="form-text">
                                • Used to allow users to upload location data files, such as exported Google Timeline
                                JSON data.<br/>
                                • Set to <code>-1</code> to disable uploads entirely.<br/>
                                • Set to <code>0</code> to use the default:
                                <code>@ApplicationSettings.DefaultUploadSizeLimitMB MB</code>.<br/>
                            </div>
                        </div>
                        <hr/>
                        <div class="row">
                            <h3 class="text-center fs-4">Map Tile Cache Management</h3>
                            <div class="col-12 mb-2">
                                <strong>Cache Directory Path: </strong><code>@ViewData["CachePath"]</code>
                            </div>
                            <hr/>
                            <div class="col-5 mb-2">
                                <strong>Total Cache Files: </strong><code
                                    id="TotalCacheFiles">@ViewData["TotalCacheFiles"]</code>
                            </div>
                            <div class="col-7 mb-2">
                                <strong>Total LRU (Least Recently Used) Cache Files for zoom levels >= 9: </strong><code
                                    id="LruTotalFiles">@ViewData["LruTotalFiles"]</code>
                            </div>
                            <hr/>
                            <div class="col-5 mb-2">
                                <strong>Total Cache Size in Megabytes: </strong><code
                                    id="TotalCacheSize">@ViewData["TotalCacheSize"] MB</code>
                            </div>
                            <div class="col-7 mb-2">
                                <strong>Total LRU Size (zoom levels >= 9) in Megabytes: </strong><code
                                    id="TotalLru">@ViewData["TotalLru"] MB</code>
                            </div>

                            <hr/>
                            <div class="col-5 mb-2">
                                <strong>Total Cache Size in Gigabytes: </strong><code
                                    id="TotalCacheSizeGB">@ViewData["TotalCacheSizeGB"] GB</code>
                            </div>

                            <div class="col-7 mb-2">
                                <strong>Total LRU Size (zoom levels >= 9) in Gigabytes: </strong><code
                                    id="TotalLruGB">@ViewData["TotalLruGB"] GB</code>
                            </div>
                            <hr/>
                            <div class="col-md-8">
                                <label for="MaxCacheTileSizeInMB" class="form-label">
                                    Maximum Size for Tile Cache in Megabytes:
                                </label>

                                <div class="input-group">
                                    <input asp-for="MaxCacheTileSizeInMB"
                                           class="form-control"
                                           type="number"
                                           step="0.01"
                                           min="-1"/>
                                    <span class="input-group-text">MB</span>
                                </div>

                                <span asp-validation-for="MaxCacheTileSizeInMB" class="text-danger"></span>

                                <div class="form-text">
                                    • This setting controls the maximum cache size (in MB) for map tiles at zoom levels
                                    ≥ 9.<br/>
                                    • Set to <code>-1</code> to disable this cache entirely.<br/>
                                    • Set to <code>0</code> to fallback to the default:
                                    <code>@ApplicationSettings.DefaultMaxCacheTileSizeInMB MB</code>.<br/>
                                    • Tiles are ~10–20 KB each. The default (1024 MB) holds roughly 100,000–200,000
                                    tiles.<br/>
                                    • Zoom levels 0–8 are cached permanently and do not count against this size. They
                                    consume ~1.31 to 1.75 GB.<br/>
                                    • Increasing this value reduces OSM server usage. If exceeded, least-recently-used
                                    tiles are purged.<br/>
                                </div>
                            </div>


                            <div class="col-md-4">
                                <div class="row mt-3">
                                    <div class="col">
                                        <a href="#" class="btn btn-danger" id="clearLruCache"
                                           title="Clear LRU Map Cache">Clear LRU Cache (zoom levels >= 9)</a>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col"><a href="#" class="btn btn-danger" id="clearAllCache"
                                                        title="Clear All Map Cache">Clear All Map Tile Cache!</a></div>
                                </div>
                            </div>

                        </div>

                        <hr/>
                        
                        <div class="row">
                            <h3 class="text-center fs-2">Total Disk Usage</h3>

                            <div class="col-4 mb-2 fs-5">
                                <strong>Map Tiles Cache (zoom ≥ 9):</strong><br/>
                                <code>@ViewData["TotalCacheSize"] MB</code> /
                                <code>@ViewData["TotalCacheSizeGB"] GB</code>
                            </div>

                            <div class="col-4 mb-2 fs-5">
                                <strong>User Uploads (Temp):</strong><br/>
                                <code>@ViewData["UploadsSizeMB"] MB</code> / <code>@ViewData["UploadsSizeGB"] GB</code>
                            </div>
                        </div>

                        <!-- Separate row for combined total -->
                        <div class="row mt-3">
                            <div class="col-6 fs-5">
                                <strong>Total Storage Used in Megabytes:</strong>
                                <code class="text-primary">@ViewData["CombinedStorageMB"] MB</code>
                            </div>
                            <div class="col-6 fs-5">
                                <strong>Total Storage Used in Gigabytes:</strong>
                                <code class="text-primary">@ViewData["CombinedStorageGB"] GB</code>
                            </div>
                        </div>

                        <div class="form-text fs-6 mt-2">
                            • This includes storage used by: map tile cache (zoom ≥ 9),PBF used for mobile routing and routing files, and
                            uploaded files (e.g. Google Timeline JSON).<br/>
                            • Zoom levels 0–8 are permanent and not included in soft limits.<br/>
                            • Use this summary to estimate how much disk Wayfarer currently occupies on your server.
                        </div>


                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg mt-3">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            @if (TempData["Message"] != null)
            {
                <div class="alert alert-success mt-3">
                    @TempData["Message"]
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    @Html.FrontendViewScripts()
}
