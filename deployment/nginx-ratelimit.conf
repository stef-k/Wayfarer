# Nginx Rate Limiting Configuration for Wayfarer
#
# This configuration adds rate limiting to protect against:
# - Brute force attacks on login pages
# - Scanner bots
# - DDoS attempts
# - Excessive API calls
#
# DOCUMENTATION:
# For complete installation instructions, customization guide, and troubleshooting:
# See docs/developer/13-Deployment.md - Section "Security Hardening / Rate Limiting"
#
# QUICK REFERENCE:
# 1. Customize domain names, SSL paths, and rate limits (see placeholders below)
# 2. Copy to nginx: sudo cp deployment/nginx-ratelimit.conf /etc/nginx/sites-available/wayfarer
# 3. Test: sudo nginx -t
# 4. Enable and reload: sudo ln -s /etc/nginx/sites-available/wayfarer /etc/nginx/sites-enabled/ && sudo systemctl reload nginx
#
# IMPORTANT: This file contains PLACEHOLDERS - customize before deploying!

# =============================================================================
# RATE LIMIT ZONES (Add these to http {} block)
# =============================================================================

# General traffic - 10 requests per second per IP with burst of 20
limit_req_zone $binary_remote_addr zone=wayfarer_general:10m rate=10r/s;

# Login pages - 3 requests per minute per IP (stricter)
limit_req_zone $binary_remote_addr zone=wayfarer_login:10m rate=3r/m;

# API endpoints - 20 requests per second per IP
limit_req_zone $binary_remote_addr zone=wayfarer_api:10m rate=20r/s;

# Malicious scanner detection - track 404s
limit_req_zone $binary_remote_addr zone=wayfarer_404:10m rate=5r/m;

# Connection limit per IP
limit_conn_zone $binary_remote_addr zone=wayfarer_conn:10m;

# =============================================================================
# SERVER BLOCK CONFIGURATION
# =============================================================================

server {
    listen 80;
    listen [::]:80;

    # CUSTOMIZE: Replace with your domain
    server_name yourdomain.com www.yourdomain.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # CUSTOMIZE: Replace with your domain
    server_name yourdomain.com www.yourdomain.com;

    # CUSTOMIZE: Update SSL certificate paths
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/yourdomain.com/chain.pem;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Connection limit - max 10 connections per IP
    limit_conn wayfarer_conn 10;

    # General rate limiting (applied to most paths)
    limit_req zone=wayfarer_general burst=20 nodelay;

    # Logging
    # CUSTOMIZE: Update log paths
    access_log /var/log/nginx/wayfarer-access.log;
    error_log /var/log/nginx/wayfarer-error.log warn;

    # Block common exploit attempts at nginx level
    location ~ /\.(env|git|svn) {
        deny all;
        return 404;
    }

    # Block requests for .php files (this is ASP.NET, not PHP)
    location ~ \.php$ {
        limit_req zone=wayfarer_404 burst=3;
        return 404;
    }

    # Block WordPress scanner attempts
    location ~ /(wp-admin|wp-content|wp-includes|xmlrpc\.php) {
        limit_req zone=wayfarer_404 burst=3;
        return 404;
    }

    # Rate limit login pages more aggressively
    location ~ ^/Identity/Account/(Login|Register|ForgotPassword) {
        limit_req zone=wayfarer_login burst=5 nodelay;

        # CUSTOMIZE: Update proxy_pass URL if your Kestrel runs on different port
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Rate limit API endpoints
    location /api/ {
        limit_req zone=wayfarer_api burst=40 nodelay;

        # CUSTOMIZE: Update proxy_pass URL if your Kestrel runs on different port
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Main application proxy
    location / {
        # CUSTOMIZE: Update proxy_pass URL if your Kestrel runs on different port
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Serve robots.txt directly (no proxy needed for static file)
    location = /robots.txt {
        # CUSTOMIZE: Update root path to your wwwroot directory
        root /var/www/wayfarer/wwwroot;
        access_log off;
    }

    # Serve static files directly (optional, for better performance)
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # CUSTOMIZE: Update root path to your wwwroot directory
        root /var/www/wayfarer/wwwroot;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}

# =============================================================================
# NOTES:
# =============================================================================
#
# Rate Limit Explanations:
# - wayfarer_general: 10 req/sec with burst of 20 = allows temporary spikes
# - wayfarer_login: 3 req/min = prevents brute force attacks
# - wayfarer_api: 20 req/sec = allows legitimate API usage
# - wayfarer_404: 5 req/min for 404s = slows down scanners
#
# Testing Rate Limits:
# - Test with: ab -n 100 -c 10 https://yourdomain.com/
# - Monitor with: tail -f /var/log/nginx/wayfarer-error.log
#
# Fine-tuning:
# - Increase 'rate' if legitimate users hit limits
# - Increase 'burst' to allow temporary traffic spikes
# - Use 'nodelay' to process burst immediately (better UX)
# - Remove 'nodelay' to smooth traffic (better protection)
